<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Firebase Auth & Professional UI</title>

  <link href="https://cdn.jsdelivr.net/npm/@mdi/font/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@3.x/dist/vuetify.min.css" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@3.x/dist/vuetify.min.js"></script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f8fafc; }
    .auth-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .auth-card { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
    .user-info img { width: 32px; height: 32px; border-radius: 50%; }
    .professional-editor { border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-top: 16px; min-height: 60vh; background: white; font-size: 16px; line-height: 1.6; }
    .professional-editor:focus { outline: none; border-color: #1976d2; box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2); }
    .tree-header { background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color: white; padding: 16px; }
    .action-toolbar { border-bottom: 1px solid #e0e0e0; }
    .content-card { box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 12px; overflow: hidden; }
    .status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #4caf50; margin-right: 8px; }
  </style>
</head>
<body>

<div id="app">
  <v-app>
    <div v-if="!user && !treeItems.length" class="auth-container">
      <div class="auth-card">
        <v-icon size="64" color="primary" class="mb-4">mdi-book-open-page-variant-outline</v-icon>
        <h1 style="margin-bottom: 8px; color: #1976d2;">Hệ thống Tri thức Động</h1>
        <p style="color: #666; margin-bottom: 24px;">Đăng nhập để truy cập không gian làm việc của bạn</p>
        <v-btn @click="signInWithGoogle" color="primary" size="large" prepend-icon="mdi-google" block rounded="xl">Đăng nhập bằng Google</v-btn>
      </div>
    </div>

    <v-layout v-if="user || treeItems.length">
      <v-app-bar color="white" elevation="1" density="comfortable">
        <v-app-bar-nav-icon @click.stop="drawer = !drawer" color="primary"></v-app-bar-nav-icon>
        <v-toolbar-title class="text-h6 font-weight-bold" style="color: #1976d2;">Agent Data</v-toolbar-title>
        <v-spacer></v-spacer>
        <div class="d-flex align-center mr-4">
          <span class="status-indicator"></span>
          <span class="text-caption text-medium-emphasis">Đang hoạt động</span>
        </div>
        <v-menu v-if="isSignedIn">
          <template v-slot:activator="{ props }">
            <v-btn v-bind="props" variant="text" class="user-info">
              <img :src="displayUser.avatar" alt="Avatar">
              <span class="text-body-2 ml-2">{{ displayUser.name }}</span>
              <v-icon right>mdi-chevron-down</v-icon>
            </v-btn>
          </template>
          <v-list>
            <v-list-item @click="signOut"><v-list-item-title><v-icon left>mdi-logout</v-icon> Đăng xuất</v-list-item-title></v-list-item>
          </v-list>
        </v-menu>
        <v-btn
          v-else
          color="primary"
          variant="outlined"
          class="ml-4"
          prepend-icon="mdi-login"
          @click="signInWithGoogle"
        >Đăng nhập</v-btn>
      </v-app-bar>

      <v-navigation-drawer v-model="drawer" :temporary="isMobile" width="300">
        <div class="tree-header">
          <h3 class="text-h6 font-weight-medium mb-1">Cây Tri thức</h3>
          <p class="text-caption mb-0 opacity-90">Quản lý tài liệu và dự án</p>
        </div>
        <v-divider></v-divider>
        <v-alert
          v-if="treeLoadError"
          type="error"
          variant="tonal"
          class="ma-2"
        >{{ treeLoadError }}</v-alert>
        <div class="d-flex justify-center pa-2" v-if="isLoadingTree">
          <v-progress-circular indeterminate color="primary"></v-progress-circular>
        </div>
        <v-treeview :items="treeItems" item-value="id" @update:activated="onNodeSelect" activatable density="compact" class="pa-2" open-all>
          <template v-slot:prepend="{ item }">
            <v-icon :color="item.children ? 'primary' : 'grey-darken-1'" size="small">{{ item.children ? 'mdi-folder-outline' : 'mdi-file-document-outline' }}</v-icon>
          </template>
        </v-treeview>
      </v-navigation-drawer>

      <v-main class="main-content" style="background-color: #f8fafc;">
        <v-container fluid class="pa-4">
          <v-card class="content-card">
            <v-toolbar density="comfortable" class="action-toolbar" color="white">
              <v-toolbar-title class="font-weight-bold text-grey-darken-3">
                {{ selectedNode ? selectedNode.title : 'Vui lòng chọn một tài liệu' }}
              </v-toolbar-title>
              <v-spacer></v-spacer>
              <v-btn-group variant="outlined" density="comfortable">
                <v-btn icon="mdi-content-save" title="Lưu" color="primary"></v-btn>
                <v-btn icon="mdi-printer" title="In"></v-btn>
                <v-btn icon="mdi-share-variant" title="Chia sẻ"></v-btn>
              </v-btn-group>
              <v-divider vertical class="mx-2"></v-divider>
              <v-btn-group variant="outlined" density="comfortable">
                <v-btn icon="mdi-file-export-outline" title="Xuất file"></v-btn>
                <v-btn icon="mdi-history" title="Lịch sử"></v-btn>
                <v-btn icon="mdi-information-outline" title="Thông tin"></v-btn>
              </v-btn-group>
            </v-toolbar>
            <v-card-text class="pa-0">
              <div ref="editorRef" class="professional-editor" contenteditable="true" v-html="editorContent"></div>
            </v-card-text>
          </v-card>
        </v-container>
      </v-main>
    </v-layout>
  </v-app>
</div>

<script>
  const { createApp, ref, onMounted, watch, computed } = Vue;
  const { createVuetify } = Vuetify;

  const vuetify = createVuetify({
    theme: { defaultTheme: 'light', themes: { light: { colors: { primary: '#1976d2' } } } },
  });

  const app = createApp({
    setup() {
      const user = ref(null);
      // Fixed mobile detection logic
      const isMobile = computed(() => window.innerWidth < 960);
      const drawer = ref(null);
      const selectedNode = ref(null);
      const editorRef = ref(null);
      const editorContent = ref(`<h2>Chào mừng bạn!</h2><p>Chọn một tài liệu từ cây thư mục bên trái để bắt đầu.</p>`);

      // Initialize drawer based on mobile state
      watch(isMobile, (mobile) => {
        drawer.value = !mobile;
      }, { immediate: true });

      const treeItems = ref([]);
      const isLoadingTree = ref(false);
      const treeLoadError = ref('');
      const API_BASE_URL = 'https://agent-data-test-service-pfne2mqwja-as.a.run.app';

      const normaliseTree = (items = []) => items.map(item => ({
        id: item.id,
        title: item.title,
        parent: item.parent ?? null,
        source_document_id: item.source_document_id ?? null,
        children: normaliseTree(item.children || []),
      }));

      const fetchTree = async () => {
        try {
          treeLoadError.value = '';
          isLoadingTree.value = true;
          console.log('Đang chuẩn bị gọi API...');
          const response = await fetch(`${API_BASE_URL}/api/v1/knowledge-tree`);
          console.log('Đã nhận được phản hồi từ API:', response);
          if (!response.ok) {
            throw new Error(`Fetch failed with status ${response.status}`);
          }
          const payload = await response.json();
          console.log('Dữ liệu sau khi parse JSON:', payload);
          const treeData = payload?.tree ?? payload?.data?.tree ?? [];
          const rawTree = Array.isArray(treeData) ? treeData : [];
          treeItems.value = normaliseTree(rawTree);
          console.log('Dữ liệu cuối cùng được gán cho Tree View:', treeItems.value);
        } catch (error) {
          console.error('Failed to load knowledge tree', error);
          treeLoadError.value = 'Không thể tải dữ liệu cây tri thức. Vui lòng thử lại sau.';
          treeItems.value = [];
        } finally {
          isLoadingTree.value = false;
        }
      };

      const firebaseConfig = {
        apiKey: "AIzaSyA3nEhCqAl7XsOljcDY_z9_7g02NG8SAwY",
        authDomain: "github-chatgpt-ggcloud.firebaseapp.com",
        projectId: "github-chatgpt-ggcloud",
        storageBucket: "github-chatgpt-ggcloud.appspot.com",
        messagingSenderId: "812872501910",
        appId: "1:812872501910:web:71a92d4200a187c55250b7",
        measurementId: "G-MVYG2LN378"
      };

      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();

      const isSignedIn = computed(() => !!user.value);
      const displayUser = computed(() => ({
        name: user.value?.displayName || user.value?.email || 'Chế độ xem khách',
        email: user.value?.email || 'guest@agent-data.local',
        avatar: user.value?.photoURL || 'https://via.placeholder.com/32'
      }));

      onMounted(() => {
        auth.onAuthStateChanged(currentUser => {
          user.value = currentUser;
          if (currentUser) {
            fetchTree();
          }
        });

        // Handle window resize for mobile responsiveness
        window.addEventListener('resize', () => {
          const mobile = window.innerWidth < 960;
          drawer.value = !mobile;
        });

        fetchTree();
      });

      const onNodeSelect = (nodes) => {
        if (nodes.length > 0) {
          const findNode = (items, id) => {
            for (const item of items) {
              if (item.id === id) return item;
              if (item.children) {
                const found = findNode(item.children, id);
                if (found) return found;
              }
            }
            return null;
          };
          selectedNode.value = findNode(treeItems.value, nodes[0]);
          if (isMobile.value) { drawer.value = false; }
        }
      };

      watch(selectedNode, (newNode) => {
        if (newNode) {
          const fileExtension = (newNode.title.split('.').pop() || '').toLowerCase();
          let content = `<h2>${newNode.title}</h2><p><strong>Loại tài liệu:</strong> ${fileExtension === 'docx' ? 'Microsoft Word Document' : fileExtension === 'pdf' ? 'PDF Document' : fileExtension === 'md' ? 'Markdown Document' : 'Tài liệu'}</p><p><strong>Trạng thái:</strong> <span style="color: #4caf50;">Đang chỉnh sửa</span></p><p><strong>Người tạo:</strong> ${user.value?.displayName || 'N/A'}</p><p><strong>Ngày tạo:</strong> ${new Date().toLocaleDateString('vi-VN')}</p><h3>Nội dung chính</h3><p>Đây là tài liệu "${newNode.title}" được tạo trong hệ thống quản lý tri thức.</p><p>Bạn có thể bắt đầu chỉnh sửa nội dung bằng cách nhấp vào đây.</p><h3>Các tính năng hỗ trợ</h3><ul><li>Chỉnh sửa theo thời gian thực</li><li>Tự động lưu thay đổi</li><li>Chia sẻ và cộng tác</li><li>Xuất nhiều định dạng khác nhau</li></ul>`;
          editorRef.value.innerHTML = content;
        }
      });

      const signInWithGoogle = () => { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => console.error("Sign-in error:", e)); };
      const signOut = () => { auth.signOut(); };

      return { user, drawer, isMobile, treeItems, selectedNode, editorRef, editorContent, onNodeSelect, signInWithGoogle, signOut, isLoadingTree, treeLoadError, isSignedIn, displayUser };
    }
  });

  app.use(vuetify).mount('#app');
</script>

</body>
</html>
