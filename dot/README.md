# DOT (Directus Operations Toolkit)

DOT is a set of shell and Node.js tools for Directus operations: auth, flows, schema checks, backup, and local development.

## Hybrid Environment Support

DOT tools work seamlessly on both **Cloud (Production)** and **Local** environments.

### Environment Detection

Tools automatically detect the target environment:
1. Check if `--local` or `--cloud` flag is provided
2. Check `DOT_ENV` environment variable
3. Auto-detect: if local Directus container is running and healthy â†’ local mode
4. Default: cloud mode

### Usage Examples

```bash
# Auto-detect (recommended)
./dot/bin/dot-health-check

# Force local mode
./dot/bin/dot-health-check --local

# Force cloud mode
./dot/bin/dot-backup --cloud

# Set via environment
export DOT_ENV=local
./dot/bin/dot-schema-ensure
```

### Environment Banners

Tools display clear visual indicators:
- ðŸŸ¢ **LOCAL MODE** - Green banner, localhost URLs
- ðŸ”´ **CLOUD MODE** - Red banner with production warning for destructive operations

## Requirements

- bash
- curl
- jq
- Docker (for local development)
- Node.js 20+ (for Node.js tools)

## Setup

### Cloud Mode

Set Directus admin credentials in your environment:

```bash
export DIRECTUS_ADMIN_EMAIL="admin@example.com"
export DIRECTUS_ADMIN_PASSWORD="..."
```

### Local Mode

Ensure `.env.local` exists with credentials (auto-generated by `dot-local-up`):

```bash
# Start local environment
./dot/bin/dot-local-up

# Tools will auto-detect and use local credentials
./dot/bin/dot-backup --local
```

## Tool Map

### Core Tools

| Tool | Purpose | Flags | Idempotent |
| --- | --- | --- | --- |
| `dot-auth` | Auth to Directus and export DOT_TOKEN | `--local`, `--cloud` | Yes |
| `dot-apply` | Create/refresh DOT flows from spec | `--local`, `--cloud` | Yes |
| `dot-verify` | Trigger flows; handles 403 with manual steps | `--local`, `--cloud` | Yes |
| `dot-rollback` | Delete DOT flows (prefix [DOT]) | `--local`, `--cloud` | No |

### Schema Tools

| Tool | Purpose | Flags | Idempotent |
| --- | --- | --- | --- |
| `dot-schema-ensure` | Ensure core collection agent_views | `--local`, `--cloud` | Yes |
| `dot-schema-blog-ensure` | Ensure blog schema for posts/pages_blog | `--local`, `--cloud` | Yes |
| `dot-schema-redirects-ensure` | Ensure redirects collection | `--local`, `--cloud` | Yes |
| `dot-schema-navigation-ensure` | Convert navigation singleton to collection | `--local`, `--cloud` | Yes |
| `dot-fix-permissions` | Fix Directus Public role permissions | `--local`, `--cloud` | Yes |
| `dot-seed-agency-os` | Create Agency OS collections + seed data | `--local`, `--cloud` | Yes |

### Data Tools

| Tool | Purpose | Flags | Idempotent |
| --- | --- | --- | --- |
| `dot-backup` | Backup Directus data to JSON | `--local`, `--cloud` | Yes |
| `dot-clean-data` | Wipe dummy data, keep schema intact | `--local`, `--cloud`, `--dry-run` | No |

### Health & Testing Tools

| Tool | Purpose | Flags | Idempotent |
| --- | --- | --- | --- |
| `dot-health-check` | 4-layer health check | `--local`, `--cloud` | Yes |
| `dot-spider` | Website health crawler with auth | `--local`, `--cloud`, `--max-pages` | Yes |
| `dot-test-login` | Playwright login tests | | Yes |
| `dot-cost-audit` | Cloud Run configuration snapshot | | Yes |

### Local Development Tools

| Tool | Purpose | Options |
| --- | --- | --- |
| `dot-local-up` | Start local Docker environment | |
| `dot-local-down` | Stop local Docker environment | |
| `dot-local-status` | Check local container status | |
| `dot-local-logs` | View container logs | `[service]`, `--tail N` |
| `dot-local-restart` | Restart services | `[service]`, `--rebuild` |

## Local Development Quick Start

```bash
# 1. Start local environment (connects to Cloud SQL + GCS)
./dot/bin/dot-local-up

# 2. Check status
./dot/bin/dot-local-status

# 3. View logs
./dot/bin/dot-local-logs directus

# 4. Access services
#    Directus Admin: http://localhost:8055/admin
#    Nuxt Frontend:  http://localhost:3000

# 5. Run tools in local mode
./dot/bin/dot-backup --local
./dot/bin/dot-health-check --local

# 6. Stop when done
./dot/bin/dot-local-down
```

## Configuration Files

| File | Purpose | Git Status |
| --- | --- | --- |
| `dot/config/environment.sh` | Environment detection & token management | Tracked |
| `dot/config/credentials.local.json` | Cloud admin credentials | Ignored |
| `dot/config/google-credentials.json` | GCP service account key | Ignored |
| `.env.local` | Local environment variables | Ignored |

## Safety and Laws

- No UI automation. These tools use Directus API only.
- Do not print secrets or run with `set -x`.
- Tools are designed to be idempotent; re-runs should be safe within their scope.
- Destructive operations show red banner and require confirmation in cloud mode.
- Verify changes via API before and after runs.

## Verification Examples

```bash
# Source environment first
source ./dot/config/environment.sh
init_environment --local  # or --cloud

# Core schema check
curl --globoff -sS -H "Authorization: Bearer $DOT_TOKEN" \
  "${DIRECTUS_URL}/collections/agent_views" | jq '.data.collection'

# Blog schema check (anonymous)
curl --globoff -sS \
  "${DIRECTUS_URL}/items/pages_blog?fields=featured_post.id,featured_post.slug" \
  | jq '.data.featured_post'
```

## Docs

- dot/docs/auth.md
- dot/docs/apply.md
- dot/docs/verify.md
- dot/docs/rollback.md
- dot/docs/schema-ensure.md
- dot/docs/schema-blog-ensure.md
- dot/docs/schema-redirects-ensure.md
- dot/docs/schema-navigation-ensure.md
- dot/docs/fix-gap3.md
- dot/docs/health-check.md
- dot/docs/test-login.md
- dot/docs/cost-audit.md
- dot/docs/spider.md
- dot/docs/fix-permissions.md
- dot/docs/seed-agency-os.md
- Full toolchain map: docs/projects/web_tools/actions_tools.md

## Reports

- dot/reports/DOT_APPLY_REPORT.md
- dot/reports/DOT_VERIFY_REPORT.md
