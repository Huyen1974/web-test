#!/usr/bin/env bash

# DOT Content List - List content by workflow status
# Usage: ./dot/bin/dot-content-list [status] [collection]
#
# Arguments:
#   status     - Filter by workflow_status: all, draft, review, approved, published (default: all)
#   collection - Directus collection name (default: knowledge_documents)
#
# Examples:
#   ./dot/bin/dot-content-list                          # List all from knowledge_documents
#   ./dot/bin/dot-content-list published                # List published only
#   ./dot/bin/dot-content-list draft pages              # List drafts from pages collection
#   ./dot/bin/dot-content-list --local all posts        # Force local mode
#
# Works in both bash and zsh shells.

set -euo pipefail

# Determine script directory (works in both bash and zsh)
if [[ -n "${BASH_SOURCE[0]:-}" ]]; then
  SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
elif [[ -n "${0:-}" ]]; then
  SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
else
  SCRIPT_DIR="$(pwd)/dot/bin"
fi

# Parse arguments
LOCAL_FLAG=""
CLOUD_FLAG=""
POSITIONAL_ARGS=()

for arg in "$@"; do
  case $arg in
    --local)
      LOCAL_FLAG="--local"
      ;;
    --cloud)
      CLOUD_FLAG="--cloud"
      ;;
    --help|-h)
      echo "DOT Content List - List content by workflow status"
      echo ""
      echo "Usage: ./dot/bin/dot-content-list [options] [status] [collection]"
      echo ""
      echo "Options:"
      echo "  --local     Use local development environment"
      echo "  --cloud     Use cloud/production environment"
      echo "  --help, -h  Show this help"
      echo ""
      echo "Arguments:"
      echo "  status      Filter: all, draft, review, approved, published (default: all)"
      echo "  collection  Directus collection (default: knowledge_documents)"
      echo ""
      echo "Cold Start Protection:"
      echo "  This tool automatically retries failed requests to handle Cloud Run cold starts."
      echo "  Configure via environment variables:"
      echo "    DOT_RETRY_MAX=3       Max retry attempts (default: 3)"
      echo "    DOT_RETRY_TIMEOUT=30  Timeout per attempt in seconds (default: 30)"
      echo "    DOT_RETRY_DELAY=5     Initial delay between retries (default: 5)"
      echo ""
      echo "Examples:"
      echo "  ./dot/bin/dot-content-list published"
      echo "  ./dot/bin/dot-content-list --local draft posts"
      exit 0
      ;;
    *)
      POSITIONAL_ARGS+=("$arg")
      ;;
  esac
done

STATUS="${POSITIONAL_ARGS[0]:-all}"
COLLECTION="${POSITIONAL_ARGS[1]:-knowledge_documents}"

# Source central environment config
source "$SCRIPT_DIR/../config/environment.sh"

# Initialize environment (sets DIRECTUS_URL, DIRECTUS_TOKEN, etc.)
ENV_FLAG="${LOCAL_FLAG:-${CLOUD_FLAG:-}}"
init_environment "$ENV_FLAG"
print_environment_banner "$ENV_FLAG"

echo "Collection: $COLLECTION"
echo "Status Filter: $STATUS"
echo "------------------------------------------------------------"

# Get token (from environment.sh init)
TOKEN="${DIRECTUS_TOKEN:-}"
if [[ -z "$TOKEN" ]]; then
  echo -e "\033[31m[ERROR]\033[0m Failed to authenticate"
  exit 1
fi

# Build query
if [[ "$STATUS" == "all" ]]; then
  QUERY=""
else
  QUERY="?filter[workflow_status][_eq]=${STATUS}"
fi

# Fetch data using retry
if type api_with_retry &>/dev/null; then
  RESPONSE=$(api_with_retry "GET" "${DIRECTUS_URL}/items/${COLLECTION}${QUERY}" "$TOKEN")
else
  # Fallback without retry lib
  RESPONSE=$(curl -sfg --max-time 30 "${DIRECTUS_URL}/items/${COLLECTION}${QUERY}" \
    -H "Authorization: Bearer ${TOKEN}" 2>/dev/null || echo "")
fi

if [[ -z "$RESPONSE" ]]; then
  echo -e "\033[31m[ERROR]\033[0m Failed to fetch data"
  exit 1
fi

# Check if collection exists
if echo "$RESPONSE" | jq -e '.errors' >/dev/null 2>&1; then
  echo -e "\033[31m[ERROR]\033[0m $(echo "$RESPONSE" | jq -r '.errors[0].message')"
  exit 1
fi

# Count and display
COUNT=$(echo "$RESPONSE" | jq '.data | length')
echo -e "\033[32mFound: $COUNT items\033[0m\n"

if [[ "$COUNT" -gt 0 ]]; then
  echo "$RESPONSE" | jq -r '.data[] | "ID: \(.id)\n  Title: \(.title // .name // "[no title]")\n  Status: \(.workflow_status // .status // "[no status]")\n"'
fi
