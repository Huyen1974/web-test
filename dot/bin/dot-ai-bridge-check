#!/usr/bin/env bash
# =============================================================================
# dot-ai-bridge-check - Verify AI Gateway readiness
# =============================================================================
# VERSION: 1.0.0
# CHANGELOG:
#   v1.0.0 (2026-01-30): Initial version for WEB-28-AUTOMATION
#     - Checks static files (llms.txt, openapi.yaml)
#     - Checks Nuxt proxy endpoints (/api/ai/info, /api/ai/search)
#     - Checks Directus endpoints (agent_views, feedbacks)
#     - Validates permissions (public read, auth write)
# =============================================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source environment configuration if available
if [[ -f "${SCRIPT_DIR}/../config/environment.sh" ]]; then
  source "${SCRIPT_DIR}/../config/environment.sh"
fi

VERSION="1.0.0"

# URLs
NUXT_URL="${NUXT_URL:-https://ai.incomexsaigoncorp.vn}"
DIRECTUS_URL="${DIRECTUS_URL:-https://directus-test-pfne2mqwja-as.a.run.app}"

# Counters
PASS_COUNT=0
FAIL_COUNT=0
TOTAL_COUNT=0

# Logging functions
log_pass() {
  ((PASS_COUNT++))
  ((TOTAL_COUNT++))
  echo "âœ… $1"
}

log_fail() {
  ((FAIL_COUNT++))
  ((TOTAL_COUNT++))
  echo "âŒ $1"
}

log_warn() {
  ((TOTAL_COUNT++))
  echo "âš ï¸  $1"
}

log_section() {
  echo ""
  echo "[$1]"
}

require_cmds() {
  for cmd in curl jq; do
    command -v "$cmd" >/dev/null 2>&1 || { echo "âŒ Missing required command: $cmd" >&2; exit 1; }
  done
}

check_url() {
  local name="$1"
  local url="$2"
  local expected_code="${3:-200}"
  local check_content="${4:-}"

  local response code body

  response=$(curl -sS --max-time 30 -w "\n%{http_code}" "$url" 2>/dev/null || echo -e "\n000")
  body="${response%$'\n'*}"
  code="${response##*$'\n'}"

  if [[ "$code" == "$expected_code" ]]; then
    if [[ -n "$check_content" ]]; then
      if echo "$body" | grep -q "$check_content"; then
        log_pass "${name} ${code} OK (contains: ${check_content})"
        return 0
      else
        log_fail "${name} ${code} (missing: ${check_content})"
        return 1
      fi
    else
      log_pass "${name} ${code} OK"
      return 0
    fi
  else
    log_fail "${name} expected ${expected_code}, got ${code}"
    return 1
  fi
}

check_post_401() {
  local name="$1"
  local url="$2"

  local response code

  response=$(curl -sS --max-time 30 -X POST \
    -H "Content-Type: application/json" \
    -d '{"query":"test"}' \
    -w "\n%{http_code}" "$url" 2>/dev/null || echo -e "\n000")
  code="${response##*$'\n'}"

  if [[ "$code" == "401" ]]; then
    log_pass "${name} 401 OK (auth required - correct)"
    return 0
  else
    log_fail "${name} expected 401, got ${code}"
    return 1
  fi
}

check_json_data() {
  local name="$1"
  local url="$2"

  local response code body count

  response=$(curl -sS --max-time 30 -w "\n%{http_code}" "$url" 2>/dev/null || echo -e "\n000")
  body="${response%$'\n'*}"
  code="${response##*$'\n'}"

  if [[ "$code" == "200" ]]; then
    count=$(echo "$body" | jq '.data | length' 2>/dev/null || echo "0")
    log_pass "${name} ${code} OK (${count} items)"
    return 0
  else
    log_fail "${name} expected 200, got ${code}"
    return 1
  fi
}

show_help() {
  cat << EOF
dot-ai-bridge-check v${VERSION} - Verify AI Gateway readiness

Usage:
  dot-ai-bridge-check [options]

Options:
  --local       Use local URLs (localhost)
  --cloud       Use production URLs (default)
  --help, -h    Show this help message

Checks performed:
  1. Static files (llms.txt, agent_data_openapi.yaml)
  2. Nuxt proxy endpoints (/api/ai/info, /api/ai/search)
  3. Directus endpoints (agent_views, feedbacks)
  4. Permission validation (public vs authenticated)

Exit codes:
  0 - All checks passed
  1 - One or more checks failed

EOF
}

main() {
  # Parse arguments
  for arg in "$@"; do
    case "$arg" in
      --help|-h)
        show_help
        exit 0
        ;;
      --local)
        NUXT_URL="http://localhost:3000"
        DIRECTUS_URL="http://localhost:8055"
        ;;
      --cloud)
        NUXT_URL="https://ai.incomexsaigoncorp.vn"
        DIRECTUS_URL="https://directus-test-pfne2mqwja-as.a.run.app"
        ;;
    esac
  done

  require_cmds

  local timestamp
  timestamp=$(date '+%Y-%m-%d %H:%M:%S')

  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo "DOT AI BRIDGE CHECK v${VERSION} - ${timestamp}"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""
  echo "ğŸŒ Nuxt URL:     ${NUXT_URL}"
  echo "ğŸ“¦ Directus URL: ${DIRECTUS_URL}"

  # Section 1: Static Files
  log_section "STATIC FILES"
  check_url "llms.txt" "${NUXT_URL}/llms.txt" "200" "AI Gateway" || true
  check_url "openapi.yaml" "${NUXT_URL}/agent_data_openapi.yaml" "200" "openapi:" || true

  # Section 2: Nuxt Proxy Endpoints
  log_section "NUXT PROXY ENDPOINTS"
  check_url "/api/ai/info" "${NUXT_URL}/api/ai/info" "200" || true
  check_post_401 "/api/ai/search" "${NUXT_URL}/api/ai/search" || true

  # Section 3: Directus Endpoints
  log_section "DIRECTUS ENDPOINTS"
  check_json_data "agent_views" "${DIRECTUS_URL}/items/agent_views?limit=5" || true

  # Check feedbacks requires auth (should be 401 or 403)
  local fb_response fb_code
  fb_response=$(curl -sS --max-time 30 -X POST \
    -H "Content-Type: application/json" \
    -d '{"content":"test"}' \
    -w "\n%{http_code}" "${DIRECTUS_URL}/items/feedbacks" 2>/dev/null || echo -e "\n000")
  fb_code="${fb_response##*$'\n'}"

  if [[ "$fb_code" == "401" || "$fb_code" == "403" ]]; then
    log_pass "feedbacks ${fb_code} OK (auth required - correct)"
  else
    log_fail "feedbacks expected 401/403, got ${fb_code}"
  fi

  # Section 4: Permission Validation
  log_section "PERMISSION VALIDATION"

  # agent_views should be publicly readable
  local av_response av_code
  av_response=$(curl -sS --max-time 30 -w "\n%{http_code}" "${DIRECTUS_URL}/items/agent_views?limit=1" 2>/dev/null || echo -e "\n000")
  av_code="${av_response##*$'\n'}"

  if [[ "$av_code" == "200" ]]; then
    log_pass "agent_views PUBLIC READ"
  else
    log_fail "agent_views not publicly readable (got ${av_code})"
  fi

  # feedbacks should require auth for write
  if [[ "$fb_code" == "401" || "$fb_code" == "403" ]]; then
    log_pass "feedbacks WRITE PROTECTED"
  else
    log_fail "feedbacks not write-protected"
  fi

  # Summary
  echo ""
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo "[SUMMARY]"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "Passed: ${PASS_COUNT}/${TOTAL_COUNT}"
  echo "Failed: ${FAIL_COUNT}/${TOTAL_COUNT}"
  echo ""

  if [[ "$FAIL_COUNT" -eq 0 ]]; then
    echo "ğŸ‰ All ${TOTAL_COUNT} checks PASSED"
    echo "âœ… AI Gateway is READY for external AI integration"
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    exit 0
  else
    echo "âš ï¸  ${FAIL_COUNT} check(s) FAILED"
    echo ""
    echo "Troubleshooting:"
    echo "  1. Verify Cloud Run deployment completed"
    echo "  2. Check AI_GATEWAY_TOKEN is set in Cloud Run"
    echo "  3. Verify Directus permissions for AI_Agent role"
    echo "  4. Check Cloud Run logs: gcloud run logs read nuxt-ssr-pfne2mqwja"
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    exit 1
  fi
}

main "$@"
