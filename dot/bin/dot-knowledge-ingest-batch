#!/bin/bash
# dot-knowledge-ingest-batch - Ingest multiple documents from a directory
# Usage: dot-knowledge-ingest-batch /path/to/docs [--dry-run]

DIR="${1:-.}"
DRY_RUN="${2:-}"
API_KEY="${API_KEY:-C38FE9FA-2BC6-4FBB-BA0C-981E8FB89450}"
AGENT_URL="${AGENT_DATA_URL:-http://localhost:8000}"

if [ ! -d "$DIR" ]; then
    echo "Error: Directory not found: $DIR"
    exit 1
fi

echo "Batch Ingest from: $DIR"
echo "API URL: $AGENT_URL"
[ "$DRY_RUN" = "--dry-run" ] && echo "Mode: DRY RUN (no actual ingestion)"
echo ""

COUNT=0
for file in "$DIR"/*.md "$DIR"/*.txt; do
    [ -f "$file" ] || continue

    FILENAME=$(basename "$file")
    DOC_ID=$(echo "$FILENAME" | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]')

    if [ "$DRY_RUN" = "--dry-run" ]; then
        echo "Would ingest: $file -> $DOC_ID"
        COUNT=$((COUNT + 1))
    else
        echo "Ingesting: $file"

        CONTENT=$(cat "$file" | python3 -c "import sys,json; print(json.dumps(sys.stdin.read()))")

        RESPONSE=$(curl -s -X POST "$AGENT_URL/documents" \
            -H "Content-Type: application/json" \
            -H "x-api-key: $API_KEY" \
            -d "{
                \"document_id\": \"$DOC_ID\",
                \"parent_id\": \"batch-import\",
                \"content\": {
                    \"mime_type\": \"text/markdown\",
                    \"body\": $CONTENT
                },
                \"metadata\": {
                    \"title\": \"$FILENAME\",
                    \"tags\": [\"batch-import\"],
                    \"source\": \"$file\"
                },
                \"is_human_readable\": true
            }" 2>/dev/null)

        if echo "$RESPONSE" | grep -q "created\|updated"; then
            echo "  -> Success"
            COUNT=$((COUNT + 1))
        else
            echo "  -> Failed: $RESPONSE"
        fi

        sleep 1
    fi
done

echo ""
echo "Total: $COUNT documents"
[ "$DRY_RUN" = "--dry-run" ] && echo "(Dry run - no changes made)"
