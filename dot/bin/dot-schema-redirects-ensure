#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOT_AUTH="${SCRIPT_DIR}/dot-auth"

COLLECTION="redirects"
REQUIRED_FIELDS=(
  url_old
  url_new
  response_code
  notice_redirects
)

log_info() {
  echo "[INFO] $1"
}

log_ok() {
  echo "[OK] $1"
}

log_warn() {
  echo "[WARN] $1"
}

log_skip() {
  echo "[SKIP] $1"
}

log_err() {
  echo "[ERR] $1" >&2
}

require_cmds() {
  for cmd in curl jq; do
    command -v "$cmd" >/dev/null 2>&1 || { log_err "Missing required command: $cmd"; exit 1; }
  done
}

api_request() {
  local method="$1"
  local url="$2"
  local data="${3-}"
  local resp

  if [[ -n "${data-}" ]]; then
    resp=$(curl -sS --globoff -X "$method" "$url" \
      -H "Authorization: Bearer $DOT_TOKEN" \
      -H "Content-Type: application/json" \
      -d "$data" \
      -w "\n%{http_code}")
  else
    resp=$(curl -sS --globoff -X "$method" "$url" \
      -H "Authorization: Bearer $DOT_TOKEN" \
      -w "\n%{http_code}")
  fi

  printf '%s' "$resp"
}

ensure_auth() {
  if [[ -z "${DOT_TOKEN:-}" ]]; then
    if [[ ! -f "$DOT_AUTH" ]]; then
      log_err "dot-auth not found at ${DOT_AUTH}"
      exit 1
    fi
    log_info "Authenticating with Directus..."
    # shellcheck source=/dev/null
    source "$DOT_AUTH" >/dev/null
  fi

  if [[ -z "${DOT_TOKEN:-}" ]]; then
    log_err "DOT_TOKEN is empty after authentication"
    exit 1
  fi
}

collection_exists() {
  local resp body code

  resp=$(api_request GET "${BASE_URL}/collections")
  body="${resp%$'\n'*}"
  code="${resp##*$'\n'}"

  if [[ "$code" != "200" ]]; then
    log_err "Failed to list collections (HTTP $code)"
    echo "$body" | head -c 200 >&2
    exit 1
  fi

  if echo "$body" | jq -e --arg collection "$COLLECTION" '.data[]? | select(.collection == $collection)' >/dev/null; then
    return 0
  fi
  return 1
}

field_exists() {
  local field_name="$1"
  local resp body code

  resp=$(api_request GET "${BASE_URL}/fields/${COLLECTION}")
  body="${resp%$'\n'*}"
  code="${resp##*$'\n'}"

  if [[ "$code" != "200" ]]; then
    log_err "Failed to list fields for ${COLLECTION} (HTTP $code)"
    echo "$body" | head -c 200 >&2
    exit 1
  fi

  if echo "$body" | jq -e --arg field "$field_name" '.data[]? | select(.field == $field)' >/dev/null; then
    return 0
  fi
  return 1
}

get_field_type() {
  local field_name="$1"
  local resp body code

  resp=$(api_request GET "${BASE_URL}/fields/${COLLECTION}")
  body="${resp%$'\n'*}"
  code="${resp##*$'\n'}"

  if [[ "$code" != "200" ]]; then
    log_err "Failed to list fields for ${COLLECTION} (HTTP $code)"
    echo "$body" | head -c 200 >&2
    exit 1
  fi

  echo "$body" | jq -r --arg field "$field_name" '.data[]? | select(.field == $field) | .type // empty'
}

field_payload() {
  case "$1" in
    url_old)
      cat <<'JSON'
{"field":"url_old","type":"string","meta":{"required":true},"schema":{"is_nullable":false}}
JSON
      ;;
    url_new)
      cat <<'JSON'
{"field":"url_new","type":"string","meta":{"required":true},"schema":{"is_nullable":false}}
JSON
      ;;
    response_code)
      cat <<'JSON'
{"field":"response_code","type":"integer","meta":{"required":false},"schema":{"is_nullable":true}}
JSON
      ;;
    notice_redirects)
      cat <<'JSON'
{"field":"notice_redirects","type":"string","meta":{"required":false},"schema":{"is_nullable":true}}
JSON
      ;;
    *)
      return 1
      ;;
  esac
}

create_collection() {
  local payload resp body code

  payload=$(jq -nc --arg collection "$COLLECTION" --arg note "Created by DOT redirects schema ensure" '
    {
      collection: $collection,
      schema: {},
      meta: { note: $note },
      fields: [
        { field: "id", type: "uuid", meta: { required: true }, schema: { is_primary_key: true, is_nullable: false } }
      ]
    }
  ')

  log_info "Creating collection ${COLLECTION}"
  resp=$(api_request POST "${BASE_URL}/collections" "$payload")
  body="${resp%$'\n'*}"
  code="${resp##*$'\n'}"

  if [[ "$code" != "200" ]]; then
    log_err "Failed to create collection ${COLLECTION} (HTTP $code)"
    echo "$body" | head -c 200 >&2
    exit 1
  fi

  log_ok "Collection ${COLLECTION} created"
}

create_field() {
  local field_name="$1"
  local payload resp body code

  payload=$(field_payload "$field_name")
  log_info "Creating field ${COLLECTION}.${field_name}"
  resp=$(api_request POST "${BASE_URL}/fields/${COLLECTION}" "$payload")
  body="${resp%$'\n'*}"
  code="${resp##*$'\n'}"

  if [[ "$code" != "200" ]]; then
    log_err "Failed to create field ${COLLECTION}.${field_name} (HTTP $code)"
    echo "$body" | head -c 200 >&2
    exit 1
  fi

  log_ok "Field ${COLLECTION}.${field_name} created"
}

field_type_ok() {
  local field_name="$1"
  local field_type="$2"

  case "$field_name" in
    url_old|url_new|notice_redirects)
      [[ "$field_type" == "string" ]]
      ;;
    response_code)
      [[ "$field_type" == "integer" || "$field_type" == "string" ]]
      ;;
    *)
      return 1
      ;;
  esac
}

verify_fields() {
  local mismatches=()
  local field_type

  for field in "${REQUIRED_FIELDS[@]}"; do
    if ! field_exists "$field"; then
      mismatches+=("${field}:missing")
      continue
    fi

    field_type=$(get_field_type "$field")
    if [[ -z "$field_type" ]]; then
      mismatches+=("${field}:unknown")
      continue
    fi

    if ! field_type_ok "$field" "$field_type"; then
      mismatches+=("${field}:type=${field_type}")
    fi
  done

  if [[ "${#mismatches[@]}" -gt 0 ]]; then
    log_err "Field validation failed: ${mismatches[*]}"
    exit 1
  fi
}

main() {
  require_cmds
  BASE_URL="${DIRECTUS_BASE_URL:-https://directus-test-pfne2mqwja-as.a.run.app}"

  echo "========================================="
  echo "DOT Tool: Redirects Schema Ensure"
  echo "========================================="
  echo "Ensuring Directus redirects schema"
  echo "Target: ${BASE_URL}"
  echo ""

  ensure_auth

  if collection_exists; then
    log_skip "Collection '${COLLECTION}' already exists"
  else
    create_collection
  fi

  log_info "Ensuring required fields exist..."
  for field in "${REQUIRED_FIELDS[@]}"; do
    if field_exists "$field"; then
      log_skip "Field ${COLLECTION}.${field} already exists"
    else
      create_field "$field"
    fi
  done

  log_info "Running final verification..."
  verify_fields
  log_ok "Collection redirects ready"

  echo ""
  echo "========================================="
  echo "DOT Tool: Redirects Schema Ensure - COMPLETE"
  echo "========================================="
}

main "$@"
