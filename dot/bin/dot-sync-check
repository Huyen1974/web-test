#!/usr/bin/env bash
# dot-sync-check: VPS Infrastructure Health Monitor
# Usage: ./dot/bin/dot-sync-check [--verbose]
#
# Checks VPS Directus, Agent Data, anonymous read, and website health.
# Auth token is OPTIONAL — basic health checks work without it.
set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# URLs — single VPS endpoints
VPS_DIRECTUS_URL="${VPS_DIRECTUS_URL:-https://directus.incomexsaigoncorp.vn}"
VPS_AGENT_DATA_URL="${VPS_AGENT_DATA_URL:-https://vps.incomexsaigoncorp.vn/api}"
WEBSITE_URL="${WEBSITE_URL:-https://ai.incomexsaigoncorp.vn}"

# Optional auth token (nice-to-have for field count check)
STATIC_TOKEN="${DIRECTUS_STATIC_TOKEN:-}"

# Verbose mode
VERBOSE=false
[[ "${1:-}" == "--verbose" || "${1:-}" == "-v" ]] && VERBOSE=true

# Show help
if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
    echo "DOT-SYNC-CHECK - VPS Infrastructure Health Monitor"
    echo ""
    echo "Usage: dot-sync-check [--verbose]"
    echo ""
    echo "Options:"
    echo "  -v, --verbose  Show detailed info on each check"
    echo "  -h, --help     Show this help"
    echo ""
    echo "Environment:"
    echo "  VPS_DIRECTUS_URL        VPS Directus URL (default: https://directus.incomexsaigoncorp.vn)"
    echo "  VPS_AGENT_DATA_URL      VPS Agent Data URL (default: https://vps.incomexsaigoncorp.vn/api)"
    echo "  WEBSITE_URL             Website URL (default: https://ai.incomexsaigoncorp.vn)"
    echo "  DIRECTUS_STATIC_TOKEN   Optional auth token for schema checks"
    echo ""
    echo "Checks:"
    echo "  1. VPS Directus health (/server/health)"
    echo "  2. VPS Agent Data health (/health)"
    echo "  3. Anonymous read (knowledge_documents)"
    echo "  4. Website production (/knowledge)"
    echo "  5. Schema field count (optional, requires auth token)"
    exit 0
fi

echo "======================================"
echo "  DOT Health Check - VPS Infrastructure"
echo "======================================"
echo ""
echo "Directus:   $VPS_DIRECTUS_URL"
echo "Agent Data: $VPS_AGENT_DATA_URL"
echo "Website:    $WEBSITE_URL"
if [ -n "$STATIC_TOKEN" ]; then
    echo "Auth:       Static Token (from env)"
else
    echo "Auth:       None (basic checks only)"
fi
echo ""

ERRORS=0
WARNINGS=0

# --- Check 1: VPS Directus Health ---
echo -n "1. VPS Directus health............ "
DIRECTUS_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" --max-time 15 "$VPS_DIRECTUS_URL/server/health" 2>/dev/null || echo "000")
if [ "$DIRECTUS_HEALTH" == "200" ]; then
    echo -e "${GREEN}OK${NC}"
else
    echo -e "${RED}FAIL (HTTP $DIRECTUS_HEALTH)${NC}"
    ERRORS=$((ERRORS + 1))
fi

# --- Check 2: VPS Agent Data Health ---
echo -n "2. VPS Agent Data health.......... "
AD_HEALTH_HTTP=$(curl -s -o /dev/null -w "%{http_code}" --max-time 15 "$VPS_AGENT_DATA_URL/health" 2>/dev/null || echo "000")
if [ "$AD_HEALTH_HTTP" == "200" ]; then
    # Try to extract status from JSON response
    AD_BODY=$(curl -s --max-time 15 "$VPS_AGENT_DATA_URL/health" 2>/dev/null || echo "{}")
    AD_STATUS=$(echo "$AD_BODY" | grep -o '"status":"[^"]*"' | head -1 | cut -d'"' -f4 || true)
    if [ "$AD_STATUS" == "healthy" ]; then
        echo -e "${GREEN}OK (healthy)${NC}"
    elif [ -n "$AD_STATUS" ]; then
        echo -e "${YELLOW}WARN (status: $AD_STATUS)${NC}"
        WARNINGS=$((WARNINGS + 1))
    else
        echo -e "${GREEN}OK${NC}"
    fi
else
    echo -e "${RED}FAIL (HTTP $AD_HEALTH_HTTP)${NC}"
    ERRORS=$((ERRORS + 1))
fi

# --- Check 3: Anonymous Read (knowledge_documents) ---
echo -n "3. Anonymous read (knowledge)..... "
if [ "$DIRECTUS_HEALTH" == "200" ]; then
    ANON_READ=$(curl -s -o /dev/null -w "%{http_code}" --max-time 15 "$VPS_DIRECTUS_URL/items/knowledge_documents?limit=1" 2>/dev/null || echo "000")
    if [ "$ANON_READ" == "200" ]; then
        echo -e "${GREEN}OK${NC}"
    else
        echo -e "${YELLOW}BLOCKED (HTTP $ANON_READ)${NC}"
        WARNINGS=$((WARNINGS + 1))
    fi
else
    echo -e "${YELLOW}SKIPPED (Directus down)${NC}"
    WARNINGS=$((WARNINGS + 1))
fi

# --- Check 4: Website (/knowledge) ---
echo -n "4. Website (/knowledge)........... "
WEB_CHECK=$(curl -s -o /dev/null -w "%{http_code}" --max-time 20 "$WEBSITE_URL/knowledge" 2>/dev/null || echo "000")
if [ "$WEB_CHECK" == "200" ]; then
    echo -e "${GREEN}OK${NC}"
else
    echo -e "${RED}FAIL (HTTP $WEB_CHECK)${NC}"
    ERRORS=$((ERRORS + 1))
fi

# --- Check 5: Schema Field Count (optional, requires auth) ---
echo -n "5. Schema field count............. "
if [ -n "$STATIC_TOKEN" ] && [ "$DIRECTUS_HEALTH" == "200" ]; then
    FIELDS_BODY=$(curl -s --max-time 15 "$VPS_DIRECTUS_URL/fields/knowledge_documents" \
        -H "Authorization: Bearer $STATIC_TOKEN" 2>/dev/null || echo "")
    # Count fields safely — grep may return nothing, so use || true
    FIELD_COUNT=$(echo "$FIELDS_BODY" | grep -o '"field":"[^"]*"' | wc -l | tr -d ' ' || true)
    FIELD_COUNT="${FIELD_COUNT:-0}"
    if [ "$FIELD_COUNT" -gt 0 ] 2>/dev/null; then
        echo -e "${GREEN}OK ($FIELD_COUNT fields)${NC}"
        if $VERBOSE; then
            FIELD_LIST=$(echo "$FIELDS_BODY" | grep -o '"field":"[^"]*"' | cut -d'"' -f4 | sort | tr '\n' ',' | sed 's/,$//' || true)
            echo -e "   ${CYAN}Fields:${NC} $FIELD_LIST"
        fi
    else
        # Check if it is an auth issue (403) or empty response
        FIELDS_HTTP=$(curl -s -o /dev/null -w "%{http_code}" --max-time 15 "$VPS_DIRECTUS_URL/fields/knowledge_documents" \
            -H "Authorization: Bearer $STATIC_TOKEN" 2>/dev/null || echo "000")
        if [ "$FIELDS_HTTP" == "401" ] || [ "$FIELDS_HTTP" == "403" ]; then
            echo -e "${YELLOW}AUTH FAILED (HTTP $FIELDS_HTTP — token may be invalid)${NC}"
            WARNINGS=$((WARNINGS + 1))
        else
            echo -e "${YELLOW}WARN (0 fields returned, HTTP $FIELDS_HTTP)${NC}"
            WARNINGS=$((WARNINGS + 1))
        fi
    fi
elif [ "$DIRECTUS_HEALTH" != "200" ]; then
    echo -e "${YELLOW}SKIPPED (Directus down)${NC}"
    WARNINGS=$((WARNINGS + 1))
else
    echo -e "${YELLOW}SKIPPED (no auth token)${NC}"
fi

# --- Summary ---
echo ""
echo "======================================"
if [ "$ERRORS" -eq 0 ] && [ "$WARNINGS" -eq 0 ]; then
    echo -e "${GREEN}  ALL CHECKS PASSED${NC}"
    exit 0
elif [ "$ERRORS" -eq 0 ]; then
    echo -e "${YELLOW}  PASSED WITH $WARNINGS WARNING(S)${NC}"
    exit 0
else
    echo -e "${RED}  $ERRORS CHECK(S) FAILED${NC}"
    [ "$WARNINGS" -gt 0 ] && echo -e "${YELLOW}  $WARNINGS WARNING(S)${NC}"
    exit 1
fi
