#!/bin/bash
# dot-arch-check: Architecture compliance checker
# Kiểm tra code tuân thủ các nguyên tắc kiến trúc
# Chạy: ./dot/bin/dot-arch-check [--ci]
# Exit code: 0 = PASS, 1+ = VIOLATIONS FOUND

set -euo pipefail

REPO_ROOT="$(cd "$(dirname "$0")/../.." && pwd)"
VIOLATIONS=0
CI_MODE=false

for arg in "$@"; do
  case "$arg" in
    --ci) CI_MODE=true ;;
  esac
done

log_violation() {
  local rule="$1" file="$2" detail="$3"
  echo "  VIOLATION [$rule]: $file"
  echo "    -> $detail"
  VIOLATIONS=$((VIOLATIONS + 1))
}

log_pass() {
  echo "  PASS [$1]: $2"
}

echo "======================================="
echo "  ARCHITECTURE COMPLIANCE CHECK"
echo "======================================="
echo ""

# --- RULE 1: NO DIRECT AGENT DATA FROM NUXT ---
# Nuxt code (web/) MUST NOT import/fetch Agent Data directly
# Only allowed through Directus SDK or server/ proxy routes
echo "--- Rule 1: Data Flow Compliance ---"
# Check web/ client code only: pages, components, composables, plugins, layouts
# Exclude: server/ (proxy OK), scripts/ (admin tools OK), .output/ (build), .nuxt/
AGENT_DATA_REFS=$(grep -rn \
  'localhost:8000\|agent-data-test-.*\.run\.app\|AGENT_DATA_URL' \
  "${REPO_ROOT}/web/" \
  --include="*.ts" --include="*.vue" --include="*.js" \
  2>/dev/null \
  | grep -v 'node_modules\|\.nuxt\|\.output\|server/\|scripts/' \
  || true)

if [ -n "$AGENT_DATA_REFS" ]; then
  while IFS= read -r line; do
    [ -z "$line" ] && continue
    FILE=$(echo "$line" | cut -d: -f1)
    log_violation "DATA-FLOW" "$FILE" \
      "Nuxt client code references Agent Data directly. Must go through server/ proxy or Directus."
  done <<< "$AGENT_DATA_REFS"
else
  log_pass "DATA-FLOW" "Nuxt client code only uses Directus SDK / server proxy"
fi

# --- RULE 2: NO HARDCODED CLOUD URLS ---
# Cloud Run URLs only allowed in dot/config/, .env files, specs, and reports
echo ""
echo "--- Rule 2: No Hardcoded Cloud URLs ---"
# Allowed locations: dot/config/, dot/specs/, .env, reports/, docs/, .output/,
# public/*.yaml (API specs), .github/workflows/ (CI), server/ (proxy), scripts/
CLOUD_URLS=$(grep -rn \
  'pfne2mqwja-as\.a\.run\.app' \
  "${REPO_ROOT}/" \
  --include="*.ts" --include="*.vue" --include="*.js" --include="*.sh" \
  --include="*.py" --include="*.yml" --include="*.yaml" \
  2>/dev/null \
  | grep -v 'node_modules\|\.nuxt\|\.output\|dot/config/\|dot/specs/\|\.env\|reports/\|docs/\|\.template\|docker-compose\|\.github/workflows/\|web/server/\|web/scripts/\|web/public/\|web/modules/directus/' \
  || true)

if [ -n "$CLOUD_URLS" ]; then
  while IFS= read -r line; do
    [ -z "$line" ] && continue
    FILE=$(echo "$line" | cut -d: -f1)
    log_violation "CLOUD-URL" "$FILE" \
      "Hardcoded Cloud Run URL outside config. Use environment.sh or .env"
  done <<< "$CLOUD_URLS"
else
  log_pass "CLOUD-URL" "No hardcoded cloud URLs in code"
fi

# --- RULE 3: NO HARDCODED SECRETS ---
echo ""
echo "--- Rule 3: No Hardcoded Secrets ---"
# Check for API keys in code (not .env files)
API_KEYS=$(grep -rn \
  'sk-proj-[A-Za-z0-9]\|sk-ant-[A-Za-z0-9]\|AIza[A-Za-z0-9]' \
  "${REPO_ROOT}/" \
  --include="*.ts" --include="*.vue" --include="*.js" --include="*.sh" \
  --include="*.py" --include="*.yml" --include="*.yaml" \
  2>/dev/null \
  | grep -v 'node_modules\|\.nuxt\|\.output\|\.env\|reports/\|\.example\|\.github/workflows/' \
  || true)

if [ -n "$API_KEYS" ]; then
  while IFS= read -r line; do
    [ -z "$line" ] && continue
    FILE=$(echo "$line" | cut -d: -f1)
    log_violation "SECRETS" "$FILE" \
      "Possible hardcoded API key in code"
  done <<< "$API_KEYS"
else
  log_pass "SECRETS" "No hardcoded API keys found"
fi

# --- RULE 4: NO NEW SERVICE ACCOUNTS ---
echo ""
echo "--- Rule 4: GC-LAW Single SA ---"
NEW_SA=$(grep -rn \
  'gcloud iam service-accounts create' \
  "${REPO_ROOT}/" \
  --include="*.sh" --include="*.yml" --include="*.yaml" --include="*.py" \
  2>/dev/null \
  | grep -v 'node_modules\|reports/' \
  || true)

if [ -n "$NEW_SA" ]; then
  while IFS= read -r line; do
    [ -z "$line" ] && continue
    FILE=$(echo "$line" | cut -d: -f1)
    log_violation "GC-LAW" "$FILE" \
      "Attempting to create new Service Account. Only chatgpt-deployer@ allowed."
  done <<< "$NEW_SA"
else
  log_pass "GC-LAW" "No new Service Account creation"
fi

# --- RULE 5: PROTECTED FILES (CI mode only) ---
if [ "$CI_MODE" = true ]; then
  echo ""
  echo "--- Rule 5: Protected Files ---"
  PROTECTED_PATTERN="^docker-compose\.yml$"
  CHANGED=$(git diff origin/main --name-only 2>/dev/null || echo "")

  FOUND_PROTECTED=false
  while IFS= read -r f; do
    if echo "$f" | grep -qE "$PROTECTED_PATTERN"; then
      log_violation "PROTECTED" "$f" \
        "Protected file modified. Requires explicit User approval."
      FOUND_PROTECTED=true
    fi
  done <<< "$CHANGED"

  if [ "$FOUND_PROTECTED" = false ]; then
    log_pass "PROTECTED" "No protected files modified"
  fi
fi

# --- SUMMARY ---
echo ""
echo "======================================="
if [ $VIOLATIONS -eq 0 ]; then
  RULE_COUNT=4
  [ "$CI_MODE" = true ] && RULE_COUNT=5
  echo "  ALL CHECKS PASSED (${RULE_COUNT} rules)"
else
  echo "  $VIOLATIONS VIOLATION(S) FOUND"
  echo "  Fix violations before committing."
fi
echo "======================================="

exit $VIOLATIONS
