#!/usr/bin/env bash
# dot-env-backup — Backup current configs as templates (secrets masked)
# Usage: dot-env-backup [--commit]
#
# Reads actual config files, replaces secrets with __PLACEHOLDER__,
# saves as templates in dot/configs/.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
WEB_TEST_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"
AGENT_DATA_DIR="/Users/nmhuyen/Documents/Manual Deploy/agent-data-test"
CONFIGS_DIR="$WEB_TEST_DIR/dot/configs"

DO_COMMIT=false
[ "${1:-}" = "--commit" ] && DO_COMMIT=true

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

ok()   { echo -e "${GREEN}OK${NC} $1"; }
warn() { echo -e "${YELLOW}WARN${NC} $1"; }

echo "=== dot-env-backup ==="
echo ""

mkdir -p "$CONFIGS_DIR"

# ----------------------------------------------------------------
# Helper: mask secrets in content
# ----------------------------------------------------------------
mask_secrets() {
  local content="$1"

  # Collect actual secret values to mask
  declare -a secret_pairs=()

  # Read from web-test/.env.local
  if [ -f "$WEB_TEST_DIR/.env.local" ]; then
    while IFS='=' read -r key value; do
      [[ "$key" =~ ^#.*$ ]] && continue
      [[ -z "$key" ]] && continue
      key=$(echo "$key" | xargs)
      value=$(echo "$value" | xargs)
      case "$key" in
        DB_PASSWORD)              secret_pairs+=("$value|__DB_PASSWORD__") ;;
        KEY)                      secret_pairs+=("$value|__DIRECTUS_KEY__") ;;
        SECRET)                   secret_pairs+=("$value|__DIRECTUS_SECRET__") ;;
        DIRECTUS_ADMIN_PASSWORD)  secret_pairs+=("$value|__ADMIN_PASSWORD__") ;;
        AGENT_DATA_API_KEY)       secret_pairs+=("$value|__AGENT_DATA_API_KEY__") ;;
        QDRANT_URL)               secret_pairs+=("$value|__QDRANT_URL__") ;;
        QDRANT_API_KEY)           secret_pairs+=("$value|__QDRANT_API_KEY__") ;;
        OPENAI_API_KEY)           secret_pairs+=("$value|__OPENAI_API_KEY__") ;;
      esac
    done < "$WEB_TEST_DIR/.env.local"
  fi

  # Apply replacements
  for pair in "${secret_pairs[@]}"; do
    local val="${pair%%|*}"
    local placeholder="${pair##*|}"
    if [ -n "$val" ]; then
      content="${content//$val/$placeholder}"
    fi
  done

  echo "$content"
}

# ----------------------------------------------------------------
# Backup Claude Desktop config
# ----------------------------------------------------------------
CLAUDE_CONFIG="$HOME/Library/Application Support/Claude/claude_desktop_config.json"
if [ -f "$CLAUDE_CONFIG" ]; then
  # Extract mcpServers section only
  MCP_JSON=$(python3 -c "
import json
with open('$CLAUDE_CONFIG') as f:
    cfg = json.load(f)
mcp = cfg.get('mcpServers', {})
if mcp:
    print(json.dumps({'mcpServers': mcp}, indent=2))
else:
    print('')
" 2>/dev/null || echo "")

  if [ -n "$MCP_JSON" ]; then
    # Mask secrets and resolve paths to placeholders
    MASKED=$(echo "$MCP_JSON" | \
      sed "s|$AGENT_DATA_DIR|__AGENT_DATA_DIR__|g" | \
      sed "s|$AGENT_DATA_DIR/venv/bin/python|__VENV_PYTHON__|g")
    MASKED=$(mask_secrets "$MASKED")
    echo "$MASKED" > "$CONFIGS_DIR/claude-desktop-mcp.json.template"
    ok "Claude Desktop MCP → claude-desktop-mcp.json.template"
  else
    warn "Claude Desktop config has no mcpServers"
  fi
else
  warn "Claude Desktop config not found"
fi

# ----------------------------------------------------------------
# Backup Claude Code MCP config
# ----------------------------------------------------------------
CLAUDE_CODE_MCP="$HOME/.claude/mcp.json"
if [ -f "$CLAUDE_CODE_MCP" ]; then
  CONTENT=$(cat "$CLAUDE_CODE_MCP")
  MASKED=$(echo "$CONTENT" | \
    sed "s|$AGENT_DATA_DIR|__AGENT_DATA_DIR__|g")
  MASKED=$(mask_secrets "$MASKED")
  echo "$MASKED" > "$CONFIGS_DIR/claude-code-mcp.json.template"
  ok "Claude Code MCP → claude-code-mcp.json.template"
else
  warn "Claude Code MCP config not found"
fi

# ----------------------------------------------------------------
# Backup Agent Data .env.local
# ----------------------------------------------------------------
if [ -f "$AGENT_DATA_DIR/.env.local" ]; then
  CONTENT=$(cat "$AGENT_DATA_DIR/.env.local")
  MASKED=$(mask_secrets "$CONTENT")
  echo "$MASKED" > "$CONFIGS_DIR/agent-data.env.template"
  ok "Agent Data .env.local → agent-data.env.template"
else
  warn "Agent Data .env.local not found"
fi

# ----------------------------------------------------------------
# Backup Directus .env.local
# ----------------------------------------------------------------
if [ -f "$WEB_TEST_DIR/.env.local" ]; then
  CONTENT=$(cat "$WEB_TEST_DIR/.env.local")
  MASKED=$(mask_secrets "$CONTENT")
  echo "$MASKED" > "$CONFIGS_DIR/directus.env.template"
  ok "Directus .env.local → directus.env.template"
else
  warn "Directus .env.local not found"
fi

# ----------------------------------------------------------------
# Commit if requested
# ----------------------------------------------------------------
if [ "$DO_COMMIT" = true ]; then
  echo ""
  echo "Committing templates..."
  cd "$WEB_TEST_DIR"
  git add dot/configs/
  git commit -m "chore: backup config templates (secrets masked)" || echo "Nothing to commit"
fi

echo ""
echo "Templates saved to: $CONFIGS_DIR/"
echo "Verify no secrets leaked: grep -r 'sk-proj\|eyJh\|Pass123' dot/configs/"
