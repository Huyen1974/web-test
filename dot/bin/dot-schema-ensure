#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOT_AUTH="${SCRIPT_DIR}/dot-auth"

# Source environment configuration
source "${SCRIPT_DIR}/../config/environment.sh"

COLLECTION="agent_views"
REQUIRED_FIELDS=(
  source_id
  permalink
  title
  content
  summary
  tags
  is_global
)

log_info() {
  echo "[INFO] $1"
}

log_ok() {
  echo "[OK] $1"
}

log_warn() {
  echo "[WARN] $1"
}

log_skip() {
  echo "[SKIP] $1"
}

log_err() {
  echo "[ERR] $1" >&2
}

require_cmds() {
  for cmd in curl jq; do
    command -v "$cmd" >/dev/null 2>&1 || { log_err "Missing required command: $cmd"; exit 1; }
  done
}

api_request() {
  local method="$1"
  local url="$2"
  local data="${3-}"
  local resp

  if [[ -n "${data-}" ]]; then
    resp=$(curl -sS --globoff -X "$method" "$url" \
      -H "Authorization: Bearer $DOT_TOKEN" \
      -H "Content-Type: application/json" \
      -d "$data" \
      -w "\n%{http_code}")
  else
    resp=$(curl -sS --globoff -X "$method" "$url" \
      -H "Authorization: Bearer $DOT_TOKEN" \
      -w "\n%{http_code}")
  fi

  printf '%s' "$resp"
}

field_payload() {
  case "$1" in
    source_id)
      cat <<'JSON'
{"field":"source_id","type":"string","meta":{"required":true},"schema":{"is_nullable":false}}
JSON
      ;;
    permalink)
      cat <<'JSON'
{"field":"permalink","type":"string","meta":{"required":true},"schema":{"is_nullable":false,"is_unique":true}}
JSON
      ;;
    title)
      cat <<'JSON'
{"field":"title","type":"string","meta":{"required":false},"schema":{"is_nullable":true}}
JSON
      ;;
    content)
      cat <<'JSON'
{"field":"content","type":"text","meta":{"required":false},"schema":{"is_nullable":true}}
JSON
      ;;
    summary)
      cat <<'JSON'
{"field":"summary","type":"text","meta":{"required":false},"schema":{"is_nullable":true}}
JSON
      ;;
    tags)
      cat <<'JSON'
{"field":"tags","type":"json","meta":{"required":false},"schema":{"is_nullable":true}}
JSON
      ;;
    is_global)
      cat <<'JSON'
{"field":"is_global","type":"boolean","meta":{"required":false},"schema":{"is_nullable":true}}
JSON
      ;;
    *)
      return 1
      ;;
  esac
}

collection_exists() {
  local resp body code
  resp=$(api_request GET "${BASE_URL}/collections")
  body="${resp%$'\n'*}"
  code="${resp##*$'\n'}"

  if [[ "$code" == "200" ]]; then
    if echo "$body" | jq -e --arg collection "$COLLECTION" '.data[]? | select(.collection == $collection)' >/dev/null; then
      return 0
    fi
    return 1
  fi

  log_err "Failed to check collection ${COLLECTION} (HTTP $code)"
  echo "$body" | head -c 200 >&2
  exit 1
}

field_exists() {
  local field_name="$1"
  local resp body code

  resp=$(api_request GET "${BASE_URL}/fields/${COLLECTION}")
  body="${resp%$'\n'*}"
  code="${resp##*$'\n'}"

  if [[ "$code" == "200" ]]; then
    if echo "$body" | jq -e --arg field "$field_name" '.data[]? | select(.field == $field)' >/dev/null; then
      return 0
    fi
    return 1
  fi

  log_err "Failed to check field ${COLLECTION}.${field_name} (HTTP $code)"
  echo "$body" | head -c 200 >&2
  exit 1
}

create_collection() {
  local fields_json payload resp body code

  fields_json=$(for field in "${REQUIRED_FIELDS[@]}"; do field_payload "$field"; done | jq -s '.')
  payload=$(jq -nc --arg collection "$COLLECTION" --arg note "Created by DOT schema ensure" --argjson fields "$fields_json" '{collection:$collection, schema:{}, meta:{note:$note}, fields:$fields}')

  log_info "Creating collection ${COLLECTION}"
  resp=$(api_request POST "${BASE_URL}/collections" "$payload")
  body="${resp%$'\n'*}"
  code="${resp##*$'\n'}"

  if [[ "$code" != "200" ]]; then
    log_err "Failed to create collection ${COLLECTION} (HTTP $code)"
    echo "$body" | head -c 200 >&2
    exit 1
  fi

  log_ok "Collection ${COLLECTION} created"
}

create_field() {
  local field_name="$1"
  local payload resp body code

  payload=$(field_payload "$field_name")
  log_info "Creating field ${COLLECTION}.${field_name}"
  resp=$(api_request POST "${BASE_URL}/fields/${COLLECTION}" "$payload")
  body="${resp%$'\n'*}"
  code="${resp##*$'\n'}"

  if [[ "$code" != "200" ]]; then
    log_err "Failed to create field ${COLLECTION}.${field_name} (HTTP $code)"
    echo "$body" | head -c 200 >&2
    exit 1
  fi

  log_ok "Field ${COLLECTION}.${field_name} created"
}

verify_fields() {
  local resp body code missing=()

  resp=$(api_request GET "${BASE_URL}/fields/${COLLECTION}")
  body="${resp%$'\n'*}"
  code="${resp##*$'\n'}"

  if [[ "$code" != "200" ]]; then
    log_err "Failed to list fields for ${COLLECTION} (HTTP $code)"
    echo "$body" | head -c 200 >&2
    exit 1
  fi

  for field in "${REQUIRED_FIELDS[@]}"; do
    if ! echo "$body" | jq -e --arg field "$field" '.data[]? | select(.field == $field)' >/dev/null; then
      missing+=("$field")
    fi
  done

  if [[ "${#missing[@]}" -gt 0 ]]; then
    log_err "Missing required fields: ${missing[*]}"
    exit 1
  fi

  log_ok "All required fields present: ${REQUIRED_FIELDS[*]}"
}

show_help() {
  cat << 'EOF'
DOT-SCHEMA-ENSURE - Ensure required Directus collections exist

Usage:
  dot-schema-ensure [options]

Options:
  --local       Use local development environment
  --cloud       Use cloud/production environment (default)
  --help, -h    Show this help message

EOF
  show_environment_help
}

main() {
  # Parse arguments
  for arg in "$@"; do
    case "$arg" in
      --help|-h)
        show_help
        exit 0
        ;;
    esac
  done

  require_cmds

  # Initialize environment (auto-detect or use flag)
  init_environment "$@"
  BASE_URL="$DIRECTUS_URL"

  echo "========================================="
  echo "DOT Tool: Schema Ensure"
  echo "========================================="
  print_environment_banner "$@"
  echo "Ensuring required Directus collections exist"
  echo ""

  if [[ -z "${DOT_TOKEN:-}" ]]; then
    if [[ ! -f "$DOT_AUTH" ]]; then
      log_err "dot-auth not found at ${DOT_AUTH}"
      exit 1
    fi
    log_info "Authenticating with Directus..."
    # shellcheck source=/dev/null
    source "$DOT_AUTH"
  fi

  if [[ -z "${DOT_TOKEN:-}" ]]; then
    log_err "DOT_TOKEN is empty after authentication"
    exit 1
  fi

  if collection_exists; then
    log_skip "Collection '${COLLECTION}' already exists"
  else
    create_collection
  fi

  log_info "Ensuring required fields exist..."
  for field in "${REQUIRED_FIELDS[@]}"; do
    if field_exists "$field"; then
      log_skip "Field ${COLLECTION}.${field} already exists"
    else
      create_field "$field"
    fi
  done

  log_info "Running final verification..."
  if ! collection_exists; then
    log_err "Collection ${COLLECTION} missing after ensure"
    exit 1
  fi

  verify_fields
  log_ok "Collection agent_views ready"

  echo ""
  echo "========================================="
  echo "DOT Tool: Schema Ensure - COMPLETE"
  echo "========================================="
}

main "$@"
