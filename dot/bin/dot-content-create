#!/usr/bin/env bash

# dot-content-create: Create new content item in Directus
# Usage: ./dot/bin/dot-content-create <collection> --title "Title" [options]
#
# Arguments:
#   collection  - Directus collection name (e.g., knowledge_documents, posts, pages)
#
# Options:
#   --title     - Document title (required unless --json provided)
#   --slug      - URL slug (auto-generated from title if not provided)
#   --status    - workflow_status: draft, review, published (default: draft)
#   --parent    - Parent document ID (for hierarchical collections)
#   --json      - Raw JSON payload (overrides other field options)
#   --local     - Use local development environment
#   --cloud     - Use cloud/production environment
#   --help, -h  - Show this help
#
# Examples:
#   ./dot/bin/dot-content-create knowledge_documents --title "New Article"
#   ./dot/bin/dot-content-create knowledge_documents --title "Guide" --status published
#   ./dot/bin/dot-content-create knowledge_documents --json '{"title":"API Created","content":"Body"}'

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Determine script directory
if [[ -n "${BASH_SOURCE[0]:-}" ]]; then
  SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
elif [[ -n "${0:-}" ]]; then
  SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
else
  SCRIPT_DIR="$(pwd)/dot/bin"
fi

# Parse arguments
LOCAL_FLAG=""
CLOUD_FLAG=""
TITLE=""
SLUG=""
STATUS="draft"
PARENT=""
JSON_PAYLOAD=""
COLLECTION=""

show_help() {
  cat <<'EOF'
dot-content-create: Create new content item in Directus

Usage: ./dot/bin/dot-content-create <collection> --title "Title" [options]

Arguments:
  collection  - Directus collection name (e.g., knowledge_documents, posts, pages)

Options:
  --title     - Document title (required unless --json provided)
  --slug      - URL slug (auto-generated from title if not provided)
  --status    - workflow_status: draft, review, published (default: draft)
  --parent    - Parent document ID (for hierarchical collections)
  --json      - Raw JSON payload (overrides other field options)
  --local     - Use local development environment
  --cloud     - Use cloud/production environment
  --help, -h  - Show this help

Auto-Slug:
  If --slug is not provided, it will be auto-generated from --title:
  "Bài Viết Mới" -> "bai-viet-moi"

Idempotency:
  If a document with the same slug already exists, the tool will return
  the existing document ID instead of creating a duplicate.

Examples:
  ./dot/bin/dot-content-create knowledge_documents --title "New Article"
  ./dot/bin/dot-content-create knowledge_documents --title "Guide" --status published
  ./dot/bin/dot-content-create knowledge_documents --json '{"title":"API Created"}'
EOF
  exit 0
}

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --local)
      LOCAL_FLAG="--local"
      shift
      ;;
    --cloud)
      CLOUD_FLAG="--cloud"
      shift
      ;;
    --title)
      TITLE="$2"
      shift 2
      ;;
    --slug)
      SLUG="$2"
      shift 2
      ;;
    --status)
      STATUS="$2"
      shift 2
      ;;
    --parent)
      PARENT="$2"
      shift 2
      ;;
    --json)
      JSON_PAYLOAD="$2"
      shift 2
      ;;
    --help|-h)
      show_help
      ;;
    -*)
      echo -e "${RED}[ERROR]${NC} Unknown option: $1" >&2
      exit 1
      ;;
    *)
      if [[ -z "$COLLECTION" ]]; then
        COLLECTION="$1"
      fi
      shift
      ;;
  esac
done

# Validate required args
if [[ -z "$COLLECTION" ]]; then
  echo -e "${RED}[ERROR]${NC} Collection is required" >&2
  echo "Usage: ./dot/bin/dot-content-create <collection> --title \"Title\"" >&2
  exit 1
fi

if [[ -z "$JSON_PAYLOAD" && -z "$TITLE" ]]; then
  echo -e "${RED}[ERROR]${NC} --title or --json is required" >&2
  exit 1
fi

# Environment detection
detect_env() {
  if [[ -n "$LOCAL_FLAG" ]]; then echo "local"; return; fi
  if [[ -n "$CLOUD_FLAG" ]]; then echo "cloud"; return; fi
  if [[ "${DOT_ENV:-}" == "local" ]]; then echo "local"; return; fi
  if [[ "${DOT_ENV:-}" == "cloud" ]]; then echo "cloud"; return; fi
  if curl -sf --max-time 2 "http://localhost:8055/server/health" >/dev/null 2>&1; then
    echo "local"
  else
    echo "cloud"
  fi
}

ENV=$(detect_env)

if [[ "$ENV" == "local" ]]; then
  DIRECTUS_URL="http://localhost:8055"
  echo -e "\n${GREEN}  DOT CONTENT CREATE - LOCAL MODE${NC}"
else
  DIRECTUS_URL="https://directus-test-pfne2mqwja-as.a.run.app"
  echo -e "\n${YELLOW}  DOT CONTENT CREATE - CLOUD MODE${NC}"
fi

echo "Collection: $COLLECTION"
echo "------------------------------------------------------------"

# Get token
ENV_FLAG="--cloud"
[[ "$ENV" == "local" ]] && ENV_FLAG="--local"

TOKEN=$("$SCRIPT_DIR/dot-token" "$ENV_FLAG")
if [[ -z "$TOKEN" ]]; then
  echo -e "${RED}[ERROR]${NC} Failed to authenticate" >&2
  exit 1
fi

# Generate UUID (cross-platform)
generate_uuid() {
  if command -v uuidgen &>/dev/null; then
    uuidgen | tr '[:upper:]' '[:lower:]'
  elif [[ -f /proc/sys/kernel/random/uuid ]]; then
    cat /proc/sys/kernel/random/uuid
  else
    # Fallback: use openssl
    openssl rand -hex 16 | sed 's/\(.\{8\}\)\(.\{4\}\)\(.\{4\}\)\(.\{4\}\)\(.\{12\}\)/\1-\2-\3-\4-\5/'
  fi
}

# Auto-generate slug from title if not provided
generate_slug() {
  local title="$1"
  # Convert to lowercase, replace spaces with dashes, remove special chars
  echo "$title" | \
    tr '[:upper:]' '[:lower:]' | \
    sed 's/[àáạảãâầấậẩẫăằắặẳẵ]/a/g' | \
    sed 's/[èéẹẻẽêềếệểễ]/e/g' | \
    sed 's/[ìíịỉĩ]/i/g' | \
    sed 's/[òóọỏõôồốộổỗơờớợởỡ]/o/g' | \
    sed 's/[ùúụủũưừứựửữ]/u/g' | \
    sed 's/[ỳýỵỷỹ]/y/g' | \
    sed 's/đ/d/g' | \
    sed 's/ /-/g' | \
    sed 's/[^a-z0-9-]//g' | \
    sed 's/-\+/-/g' | \
    sed 's/^-//' | \
    sed 's/-$//'
}

# Build JSON payload
if [[ -n "$JSON_PAYLOAD" ]]; then
  PAYLOAD="$JSON_PAYLOAD"
  # Extract slug from JSON for idempotency check
  SLUG=$(echo "$PAYLOAD" | jq -r '.slug // empty' 2>/dev/null || echo "")
  if [[ -z "$SLUG" ]]; then
    TITLE_FROM_JSON=$(echo "$PAYLOAD" | jq -r '.title // empty' 2>/dev/null || echo "")
    if [[ -n "$TITLE_FROM_JSON" ]]; then
      SLUG=$(generate_slug "$TITLE_FROM_JSON")
      PAYLOAD=$(echo "$PAYLOAD" | jq --arg s "$SLUG" '. + {slug: $s}')
    fi
  fi
else
  # Generate slug if not provided
  if [[ -z "$SLUG" ]]; then
    SLUG=$(generate_slug "$TITLE")
  fi
  
  # Build payload using jq (safe JSON handling)
  PAYLOAD=$(jq -n \
    --arg title "$TITLE" \
    --arg slug "$SLUG" \
    --arg status "$STATUS" \
    '{title: $title, slug: $slug, workflow_status: $status}')
  
  # Add parent if provided
  if [[ -n "$PARENT" ]]; then
    PAYLOAD=$(echo "$PAYLOAD" | jq --arg p "$PARENT" '. + {parent_document_id: ($p | tonumber)}')
  fi
fi

# Add required fields for knowledge_documents collection
if [[ "$COLLECTION" == "knowledge_documents" ]]; then
  # Generate version_group_id if not present
  if ! echo "$PAYLOAD" | jq -e '.version_group_id' >/dev/null 2>&1; then
    VERSION_GROUP_ID=$(generate_uuid)
    PAYLOAD=$(echo "$PAYLOAD" | jq --arg vg "$VERSION_GROUP_ID" '. + {version_group_id: $vg, version_number: 1, is_current_version: true}')
  fi
fi

echo -e "${CYAN}Slug: $SLUG${NC}"

# Idempotency check: check if slug already exists
echo -n "Checking for existing document... "
EXISTING=$(curl -sf --max-time 15 \
  "${DIRECTUS_URL}/items/${COLLECTION}?filter[slug][_eq]=${SLUG}&fields=id,title,slug" \
  -H "Authorization: Bearer ${TOKEN}" 2>/dev/null || echo "")

if [[ -n "$EXISTING" ]]; then
  EXISTING_ID=$(echo "$EXISTING" | jq -r '.data[0].id // empty' 2>/dev/null)
  if [[ -n "$EXISTING_ID" && "$EXISTING_ID" != "null" ]]; then
    echo -e "${YELLOW}EXISTS${NC}"
    echo -e "${YELLOW}[SKIP]${NC} Document with slug '$SLUG' already exists"
    echo -e "ID: ${GREEN}$EXISTING_ID${NC}"
    exit 0
  fi
fi
echo "OK"

# Create the document
echo "Creating document..."
TMP_PAYLOAD=$(mktemp)
echo "$PAYLOAD" > "$TMP_PAYLOAD"
trap 'rm -f "$TMP_PAYLOAD"' EXIT

RESPONSE=$(curl -sf --max-time 30 \
  "${DIRECTUS_URL}/items/${COLLECTION}" \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d @"$TMP_PAYLOAD" 2>/dev/null || echo "")

if [[ -z "$RESPONSE" ]]; then
  echo -e "${RED}[ERROR]${NC} Failed to create document (no response)" >&2
  exit 1
fi

# Check for errors
if echo "$RESPONSE" | jq -e '.errors' >/dev/null 2>&1; then
  ERROR_MSG=$(echo "$RESPONSE" | jq -r '.errors[0].message // "Unknown error"')
  echo -e "${RED}[ERROR]${NC} $ERROR_MSG" >&2
  exit 1
fi

# Extract created ID
CREATED_ID=$(echo "$RESPONSE" | jq -r '.data.id // empty')
CREATED_TITLE=$(echo "$RESPONSE" | jq -r '.data.title // empty')

if [[ -z "$CREATED_ID" || "$CREATED_ID" == "null" ]]; then
  echo -e "${RED}[ERROR]${NC} Failed to create document (no ID returned)" >&2
  echo "Response: $RESPONSE" >&2
  exit 1
fi

echo -e "${GREEN}[SUCCESS]${NC} Document created"
echo -e "ID: ${GREEN}$CREATED_ID${NC}"
echo -e "Title: $CREATED_TITLE"
echo -e "Slug: $SLUG"
echo -e "Status: $STATUS"
