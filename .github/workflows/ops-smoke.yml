name: ops-smoke

on:
  pull_request:
    paths:
      - 'web/**'
      - 'scripts/**'
      - '.github/workflows/ops-smoke.yml'
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *' # Every 30 mins

env:
  DIRECTUS_BASE_URL: "https://directus-test-pfne2mqwja-as.a.run.app"
  SMOKE_ASSET_ID: "cf9f9030-bc76-4b9a-86f9-8e87c42febe6"

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Check Directus Server Ping
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            --connect-timeout 10 --max-time 60 \
            "${{ env.DIRECTUS_BASE_URL }}/server/ping")
          echo "Directus Ping: $HTTP_CODE"
          if [[ "$HTTP_CODE" != "200" ]]; then
            echo "::error::Server Ping Failed (Expected 200, Got $HTTP_CODE)"
            exit 1
          fi

      - name: Check Public Pages API (Anonymous)
        run: |
          # Use --globoff (-g) for bracket filters in query string
          HTTP_CODE=$(curl --globoff -s -o /dev/null -w "%{http_code}" \
            --connect-timeout 10 --max-time 60 \
            "${{ env.DIRECTUS_BASE_URL }}/items/pages?filter[permalink][_eq]=/")
          echo "Pages API Status: $HTTP_CODE"
          if [[ "$HTTP_CODE" != "200" ]]; then
            echo "::error::Public Pages API Access Failed (Expected 200, Got $HTTP_CODE)"
            exit 1
          fi

      - name: Check Public Asset Access (Anonymous)
        run: |
          # Check asset endpoint accessibility
          # Pass: 200 (OK) or 404 (not found but endpoint accessible)
          # Fail: 000 (timeout/network), 401 (auth required), 5xx (server error)
          # Warn: 403 (permissions issue - needs manual fix)
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            --connect-timeout 10 --max-time 60 \
            "${{ env.DIRECTUS_BASE_URL }}/assets/${{ env.SMOKE_ASSET_ID }}")
          echo "Asset Status: $HTTP_CODE"

          if [[ "$HTTP_CODE" == "200" || "$HTTP_CODE" == "404" ]]; then
            echo "✅ Asset check passed ($HTTP_CODE)"
          elif [[ "$HTTP_CODE" == "403" ]]; then
            echo "::warning::Asset returned 403 Forbidden - directus_files permissions may need configuration"
            echo "This is a known issue with public file access. Workflow continues."
          elif [[ "$HTTP_CODE" == "000" || "$HTTP_CODE" == "401" || "$HTTP_CODE" =~ ^5 ]]; then
            echo "::error::Asset Access Failed (Got $HTTP_CODE - network/auth/server error)"
            exit 1
          else
            echo "::warning::Asset returned unexpected code $HTTP_CODE"
          fi

      - name: Report Success
        if: success()
        run: echo "✅ Directus Golden State is Healthy"
