name: ops-smoke

on:
  pull_request:
    paths:
      - 'web/**'
      - 'scripts/**'
      - '.github/workflows/ops-smoke.yml'
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *' # Every 30 mins

env:
  DIRECTUS_BASE_URL: "https://directus-test-pfne2mqwja-as.a.run.app"
  SMOKE_ASSET_ID: "cf9f9030-bc76-4b9a-86f9-8e87c42febe6"

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Check Directus Server Ping
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            --connect-timeout 10 --max-time 60 \
            "${{ env.DIRECTUS_BASE_URL }}/server/ping")
          echo "Directus Ping: $HTTP_CODE"
          if [[ "$HTTP_CODE" != "200" ]]; then
            echo "::error::Server Ping Failed (Expected 200, Got $HTTP_CODE)"
            exit 1
          fi

      - name: Check Public Pages API (Anonymous)
        run: |
          # Use --globoff (-g) for bracket filters in query string
          HTTP_CODE=$(curl --globoff -s -o /dev/null -w "%{http_code}" \
            --connect-timeout 10 --max-time 60 \
            "${{ env.DIRECTUS_BASE_URL }}/items/pages?filter[permalink][_eq]=/")
          echo "Pages API Status: $HTTP_CODE"
          if [[ "$HTTP_CODE" != "200" ]]; then
            echo "::error::Public Pages API Access Failed (Expected 200, Got $HTTP_CODE)"
            exit 1
          fi

      - name: Check Public Asset Access (Anonymous)
        run: |
          # Strict check: Golden Asset MUST return 200 (fail on 403/404/5xx)
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            --connect-timeout 10 --max-time 60 \
            "${{ env.DIRECTUS_BASE_URL }}/assets/${{ env.SMOKE_ASSET_ID }}")
          echo "Asset Status: $HTTP_CODE"
          if [[ "$HTTP_CODE" != "200" ]]; then
            echo "::error::Public Asset Access Failed (Expected 200, Got $HTTP_CODE)"
            exit 1
          fi

      - name: Report Success
        if: success()
        run: echo "âœ… Directus Golden State is Healthy"
