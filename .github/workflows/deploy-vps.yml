name: Deploy to VPS

on:
  # Run AFTER Firebase Deploy completes
  workflow_run:
    workflows: ["Firebase Deploy"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      services:
        description: "Services to update (comma-separated: nuxt,agent-data,all)"
        required: false
        default: "nuxt"

concurrency:
  group: deploy-vps
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

env:
  REGION: asia-southeast1
  PROJECT_ID: github-chatgpt-ggcloud
  NUXT_IMAGE: asia-southeast1-docker.pkg.dev/github-chatgpt-ggcloud/web-test/nuxt-ssr:latest
  AGENT_DATA_IMAGE: asia-southeast1-docker.pkg.dev/github-chatgpt-ggcloud/agent-data/agent-data-test:latest

jobs:
  # ===========================================================================
  # Direct Deploy: Build on GitHub → rsync .output/ → VPS restart
  # Active when DEPLOY_MODE=direct (skip Artifact Registry)
  # ===========================================================================
  deploy-direct:
    name: Build & Deploy Direct
    runs-on: ubuntu-latest
    if: >-
      vars.DEPLOY_MODE == 'direct' && (
        github.event_name == 'workflow_dispatch' ||
        (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
      )

    defaults:
      run:
        working-directory: ./web

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- Build Nuxt SSR ---
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Nuxt SSR
        env:
          NITRO_PRESET: node-server
          NODE_ENV: production
          NUXT_PUBLIC_SITE_URL: "https://ai.incomexsaigoncorp.vn"
          NUXT_PUBLIC_DIRECTUS_URL: "https://directus.incomexsaigoncorp.vn"
        run: pnpm run build

      # --- Sync config files to VPS ---
      - name: Copy config to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "infra/docker/docker-compose.yml,infra/nginx/conf.d/default.conf"
          target: "/tmp/infra-sync"
          strip_components: 0

      # --- Backup + Rsync output ---
      - name: Backup previous deploy
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euo pipefail
            mkdir -p /opt/incomex/deploys/nuxt-output
            mkdir -p /opt/incomex/deploys/nuxt-output.prev
            rm -rf /opt/incomex/deploys/nuxt-output.prev
            cp -a /opt/incomex/deploys/nuxt-output /opt/incomex/deploys/nuxt-output.prev
            echo "Backup complete: $(du -sh /opt/incomex/deploys/nuxt-output.prev | cut -f1)"

      - name: Rsync output to VPS
        uses: burnett01/rsync-deployments@7.0.1
        with:
          switches: -avz --delete
          path: web/.output/
          remote_path: /opt/incomex/deploys/nuxt-output/
          remote_host: ${{ secrets.VPS_HOST }}
          remote_user: root
          remote_key: ${{ secrets.VPS_SSH_KEY }}

      # --- Apply config + restart ---
      - name: Apply config and restart Nuxt
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euo pipefail
            cd /opt/incomex/docker

            # Sync config files
            if [ -f /tmp/infra-sync/infra/docker/docker-compose.yml ]; then
              cp /tmp/infra-sync/infra/docker/docker-compose.yml ./docker-compose.yml
              echo "Synced docker-compose.yml"
            fi
            if [ -f /tmp/infra-sync/infra/nginx/conf.d/default.conf ]; then
              cp /tmp/infra-sync/infra/nginx/conf.d/default.conf ./nginx/conf.d/default.conf
              docker exec incomex-nginx nginx -s reload 2>/dev/null || true
              echo "Synced and reloaded nginx config"
            fi
            rm -rf /tmp/infra-sync

            # Restart Nuxt (reads new .output from volume mount)
            echo "=== Restarting Nuxt ==="
            docker compose restart nuxt

            # Wait for startup
            echo "Waiting for Nuxt to start..."
            sleep 15

            # Health checks
            echo "=== Health Checks ==="
            FAILED=0

            if docker exec incomex-nuxt nc -z 127.0.0.1 3000 2>/dev/null; then
              echo "Nuxt: HEALTHY"
            else
              echo "Nuxt: UNHEALTHY"
              FAILED=1
            fi

            # Nginx+SSL: retry up to 3 times (nginx reload can cause brief gap)
            NGINX_OK=0
            for i in 1 2 3; do
              if curl -sf --connect-timeout 10 --max-time 20 -o /dev/null https://vps.incomexsaigoncorp.vn/ 2>/dev/null; then
                NGINX_OK=1
                break
              fi
              echo "Nginx+SSL: attempt $i failed, retrying in 5s..."
              sleep 5
            done
            if [[ $NGINX_OK -eq 1 ]]; then
              echo "Nginx+SSL: HEALTHY"
            else
              echo "Nginx+SSL: UNHEALTHY"
              FAILED=1
            fi

            docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}" | grep incomex

            if [[ $FAILED -ne 0 ]]; then
              echo "WARNING: Health checks failed. Rolling back..."
              rm -rf /opt/incomex/deploys/nuxt-output
              cp -a /opt/incomex/deploys/nuxt-output.prev /opt/incomex/deploys/nuxt-output
              docker compose restart nuxt
              sleep 15
              echo "Rollback complete."
              exit 1
            fi

            echo "=== Direct deploy complete ==="

  # ===========================================================================
  # Artifact Deploy: Pull Docker image from Artifact Registry → VPS restart
  # Active when DEPLOY_MODE != direct (default / artifact)
  # ===========================================================================
  deploy-artifact:
    name: Deploy via Artifact
    runs-on: ubuntu-latest
    if: >-
      vars.DEPLOY_MODE != 'direct' && (
        github.event_name == 'workflow_dispatch' ||
        (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
      )

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- GCP Auth: get short-lived access token for Artifact Registry ---
      - name: Authenticate to Google Cloud
        id: gcp-auth
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          workload_identity_provider: projects/812872501910/locations/global/workloadIdentityPools/agent-data-pool/providers/github-provider
          service_account: chatgpt-deployer@github-chatgpt-ggcloud.iam.gserviceaccount.com
          token_format: access_token

      # --- Determine which services to update ---
      - name: Determine services
        id: services
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "targets=${{ github.event.inputs.services }}" >> "$GITHUB_OUTPUT"
          else
            # Auto-deploy on push to main = nuxt only
            echo "targets=nuxt" >> "$GITHUB_OUTPUT"
          fi

      # --- Sync config files to VPS ---
      - name: Sync infra config to VPS
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # Create temp dir for receiving files
            mkdir -p /tmp/infra-sync

      - name: Copy compose file to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "infra/docker/docker-compose.yml,infra/nginx/conf.d/default.conf"
          target: "/tmp/infra-sync"
          strip_components: 0

      - name: Apply config and deploy
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          envs: NUXT_IMAGE,AGENT_DATA_IMAGE
          script: |
            set -euo pipefail
            cd /opt/incomex/docker

            # --- Sync config files from repo ---
            if [ -f /tmp/infra-sync/infra/docker/docker-compose.yml ]; then
              cp /tmp/infra-sync/infra/docker/docker-compose.yml ./docker-compose.yml
              echo "Synced docker-compose.yml"
            fi
            if [ -f /tmp/infra-sync/infra/nginx/conf.d/default.conf ]; then
              cp /tmp/infra-sync/infra/nginx/conf.d/default.conf ./nginx/conf.d/default.conf
              docker exec incomex-nginx nginx -s reload 2>/dev/null || true
              echo "Synced and reloaded nginx config"
            fi
            rm -rf /tmp/infra-sync

            # --- Login to Artifact Registry ---
            echo "${{ steps.gcp-auth.outputs.access_token }}" | \
              docker login -u oauth2accesstoken --password-stdin ${{ env.REGION }}-docker.pkg.dev

            TARGETS="${{ steps.services.outputs.targets }}"
            echo "=== Deploying: $TARGETS ==="

            # Pull new images
            if [[ "$TARGETS" == *"nuxt"* ]] || [[ "$TARGETS" == "all" ]]; then
              echo "Pulling Nuxt SSR image..."
              docker pull "$NUXT_IMAGE"
            fi

            if [[ "$TARGETS" == *"agent-data"* ]] || [[ "$TARGETS" == "all" ]]; then
              echo "Pulling Agent Data image..."
              docker pull "$AGENT_DATA_IMAGE"
            fi

            # Recreate only the updated services (zero-downtime for others)
            if [[ "$TARGETS" == "all" ]]; then
              docker compose up -d --force-recreate --no-build nuxt agent-data
            elif [[ "$TARGETS" == *"nuxt"* ]] && [[ "$TARGETS" == *"agent-data"* ]]; then
              docker compose up -d --force-recreate --no-build nuxt agent-data
            elif [[ "$TARGETS" == *"nuxt"* ]]; then
              docker compose up -d --force-recreate --no-build nuxt
            elif [[ "$TARGETS" == *"agent-data"* ]]; then
              docker compose up -d --force-recreate --no-build agent-data
            fi

            # Wait for services to be healthy
            echo "Waiting for services to stabilize..."
            sleep 15

            # Health checks
            echo "=== Health Checks ==="
            FAILED=0

            if [[ "$TARGETS" == *"nuxt"* ]] || [[ "$TARGETS" == "all" ]]; then
              if docker exec incomex-nuxt nc -z 127.0.0.1 3000 2>/dev/null; then
                echo "Nuxt: HEALTHY"
              else
                echo "Nuxt: UNHEALTHY"
                FAILED=1
              fi
            fi

            if [[ "$TARGETS" == *"agent-data"* ]] || [[ "$TARGETS" == "all" ]]; then
              if docker exec incomex-agent-data python -c 'import urllib.request; urllib.request.urlopen("http://localhost:8000/info")' 2>/dev/null; then
                echo "Agent Data: HEALTHY"
              else
                echo "Agent Data: UNHEALTHY (may need 30-45s warm-up)"
                FAILED=1
              fi
            fi

            # Nginx health (always check, retry up to 3 times)
            NGINX_OK=0
            for i in 1 2 3; do
              if curl -sf --connect-timeout 10 --max-time 20 -o /dev/null https://vps.incomexsaigoncorp.vn/ 2>/dev/null; then
                NGINX_OK=1
                break
              fi
              echo "Nginx+SSL: attempt $i failed, retrying in 5s..."
              sleep 5
            done
            if [[ $NGINX_OK -eq 1 ]]; then
              echo "Nginx+SSL: HEALTHY"
            else
              echo "Nginx+SSL: UNHEALTHY"
              FAILED=1
            fi

            docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}" | grep incomex

            # Logout from registry
            docker logout ${{ env.REGION }}-docker.pkg.dev 2>/dev/null || true

            if [[ $FAILED -ne 0 ]]; then
              echo "WARNING: Some health checks failed. Check container logs."
              exit 1
            fi

            echo "=== Deploy complete ==="
