name: Terraform Infrastructure

on:
  pull_request:
    branches:
      - main
      - 'feat/**'
      - 'fix/**'
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-*.yml'
  push:
    branches:
      - main
      - 'feat/**'
      - 'fix/**'
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-*.yml'
  workflow_dispatch:
    inputs:
      auto_apply:
        description: 'Auto-apply Terraform changes'
        required: false
        type: boolean
        default: false

jobs:
  terraform:
    name: Terraform Plan/Apply
    permissions:
      contents: read
      id-token: write
      pull-requests: write
      issues: write
    uses: ./.github/workflows/terraform-apply.yml
    with:
      project_id: github-chatgpt-ggcloud
      service_account: chatgpt-deployer@github-chatgpt-ggcloud.iam.gserviceaccount.com
      workload_identity_provider: projects/812872501910/locations/global/workloadIdentityPools/agent-data-pool/providers/github-provider
      terraform_directory: terraform
      backend_bucket: huyen1974-web-test-tfstate
      backend_prefix: terraform/state
      terraform_version: '1.9.0'
      auto_apply: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event.inputs.auto_apply == 'true' }}
