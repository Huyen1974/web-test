name: E2E Tests

on:
  # Run after Firebase Deploy completes
  workflow_run:
    workflows: ["Firebase Deploy"]
    types:
      - completed
    branches: [main]
  # Allow manual trigger
  workflow_dispatch:

jobs:
  e2e:
    runs-on: ubuntu-latest
    # Only run if Firebase Deploy was successful
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - uses: actions/checkout@v4

      # Wait for deployment to propagate
      - name: Wait for deployment propagation
        run: sleep 60

      - name: Verify Super Session accessible
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://ai.incomexsaigoncorp.vn/admin/super-session")
          echo "Super Session HTTP Code: $HTTP_CODE"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Warning: Super Session returned $HTTP_CODE (may require auth)"
          fi

      - name: Verify Directus API accessible
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://directus-test-pfne2mqwja-as.a.run.app/server/health")
          echo "Directus Health HTTP Code: $HTTP_CODE"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Error: Directus not healthy"
            exit 1
          fi

      - name: Verify AI discussions endpoint
        run: |
          RESPONSE=$(curl -s "https://directus-test-pfne2mqwja-as.a.run.app/items/ai_discussions?limit=1")
          echo "AI Discussions Response: $RESPONSE"
          if echo "$RESPONSE" | grep -q "error"; then
            echo "Error accessing ai_discussions"
            exit 1
          fi
          echo "E2E endpoint checks passed"
