name: Terraform Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Prevent concurrent Terraform deployments to avoid state conflicts
concurrency:
  group: terraform-deploy-lock
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write
  pull-requests: write

jobs:
  pass_gate:
    name: Pass Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run Nuxt type check
        run: npx nuxi typecheck

  guard_bootstrap_scaffold:
    name: Guard Bootstrap Scaffold
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Terraform structure
        run: |
          if [ ! -f "terraform/main.tf" ]; then
            echo "Error: terraform/main.tf not found"
            exit 1
          fi
          if [ ! -f "terraform/backend.tf" ]; then
            echo "Error: terraform/backend.tf not found"
            exit 1
          fi
          echo "Bootstrap scaffold validation passed"

  quality_gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run ESLint (if configured)
        run: |
          if grep -q '"lint"' package.json; then
            echo "Lint script found, running..."
            npm run lint
          else
            echo "No lint script configured, skipping"
          fi

      - name: Check package.json validity
        run: |
          node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))"
          echo "package.json is valid JSON"

  e2e_smoke_test:
    name: E2E Smoke Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Build Nuxt application
        run: npm run build

      - name: Smoke test build output
        run: |
          if [ -d ".output" ] && [ -d ".output/server" ]; then
            echo "✓ Build output validated"
          else
            echo "Error: Build output incomplete"
            exit 1
          fi

  deploy:
    name: Terraform Deploy
    runs-on: ubuntu-latest
    needs: [pass_gate, guard_bootstrap_scaffold, quality_gate, e2e_smoke_test]
    defaults:
      run:
        working-directory: ./terraform
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          token_format: 'access_token'
          create_credentials_file: true

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Ensure GCS State Bucket Exists
        run: |
          # Fix #5: CI manages tfstate bucket (not Terraform)
          BUCKET_NAME="huyen1974-web-test-tfstate"

          if ! gcloud storage buckets describe gs://${BUCKET_NAME} --project=${{ secrets.GCP_PROJECT_ID }} >/dev/null 2>&1; then
            echo "Creating GCS state bucket ${BUCKET_NAME}..."
            gcloud storage buckets create gs://${BUCKET_NAME} \
              --project=${{ secrets.GCP_PROJECT_ID }} \
              --location=asia-southeast1 \
              --uniform-bucket-level-access
            echo "✓ Bucket created"
          else
            echo "✓ Bucket already exists"
          fi
        working-directory: .

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate -no-color

      - name: Terraform Plan
        id: plan
        run: |
          set +e
          plan_output=$(terraform plan -no-color -detailed-exitcode \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -out=tfplan 2>&1)
          exit_code=$?
          set -e

          echo "$plan_output"

          if [ "$exit_code" = "1" ]; then
            echo "❌ Terraform plan failed"
            exit 1
          fi

          # Detect changes from plan output
          if echo "$plan_output" | grep -Eq "Plan: [1-9][0-9]* to add|[1-9][0-9]* to change|[1-9][0-9]* to destroy"; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "✓ Changes detected"
          elif echo "$plan_output" | grep -q "No changes"; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "✓ No changes"
          else
            [ "$exit_code" = "2" ] && echo "has_changes=true" >> $GITHUB_OUTPUT || echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with Plan
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const planStatus = '${{ steps.plan.outcome }}';
            const hasChanges = '${{ steps.plan.outputs.has_changes }}';
            const statusEmoji = planStatus === 'success' ? '✅' : '❌';

            const output = `#### Terraform Plan ${statusEmoji}

            **Status:** ${planStatus}
            **Changes Detected:** ${hasChanges === 'true' ? 'Yes' : 'No'}

            See workflow logs for detailed plan output.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      - name: Terraform Apply
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.plan.outputs.has_changes == 'true'
        run: |
          echo "Applying Terraform changes..."
          terraform apply -auto-approve tfplan

  deploy_web:
    name: Deploy (Web)
    runs-on: ubuntu-latest
    needs: [deploy]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: ./web
        run: npm install

      - name: Build Nuxt application
        working-directory: ./web
        env:
          NUXT_DIRECTUS_TOKEN: ${{ secrets.NUXT_DIRECTUS_TOKEN }}
        run: npm run build

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
          projectId: ${{ secrets.GCP_PROJECT_ID }}
          channelId: live
