name: Terraform Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Prevent concurrent Terraform deployments to avoid state conflicts
concurrency:
  group: terraform-deploy-lock
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write
  pull-requests: write

jobs:
  pass_gate:
    name: Pass Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run Nuxt type check
        run: npx nuxi typecheck

  guard_bootstrap_scaffold:
    name: Guard Bootstrap Scaffold
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Terraform structure
        run: |
          if [ ! -f "terraform/main.tf" ]; then
            echo "Error: terraform/main.tf not found"
            exit 1
          fi
          if [ ! -f "terraform/backend.tf" ]; then
            echo "Error: terraform/backend.tf not found"
            exit 1
          fi
          echo "Bootstrap scaffold validation passed"

  quality_gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run ESLint (if configured)
        run: |
          if grep -q '"lint"' package.json; then
            echo "Lint script found, running..."
            npm run lint
          else
            echo "No lint script configured in package.json, skipping"
          fi

      - name: Check package.json validity
        run: |
          node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))"
          echo "package.json is valid JSON"

      - name: Check for common issues
        run: |
          if [ -f ".env" ] || [ -f ".env.local" ]; then
            echo "Warning: .env files found in repository"
          fi
          echo "Quality checks passed"

  e2e_smoke_test:
    name: E2E Smoke Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Build Nuxt application
        run: npm run build

      - name: Smoke test build output
        run: |
          if [ -d ".output" ]; then
            echo "Build output directory exists"
            if [ -d ".output/server" ]; then
              echo "Server build found"
            else
              echo "Error: Server build not found"
              exit 1
            fi
            echo "Smoke test passed"
          else
            echo "Error: Build output not found"
            exit 1
          fi

  deploy:
    name: Super Fast Deploy
    runs-on: ubuntu-latest
    needs:
      - pass_gate
      - guard_bootstrap_scaffold
      - quality_gate
      - e2e_smoke_test
    defaults:
      run:
        working-directory: ./terraform
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          token_format: 'access_token'
          create_credentials_file: true

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Get GitHub PAT from Secret Manager
        id: get-pat
        uses: google-github-actions/get-secretmanager-secrets@v2
        with:
          secrets: |-
            github-pat:projects/${{ secrets.GCP_PROJECT_ID }}/secrets/gh_pat_sync_secrets/versions/latest

      - name: Configure Git for private modules
        run: |
          git config --global url."https://x-access-token:${{ steps.get-pat.outputs.github-pat }}@github.com/".insteadOf "https://github.com/"
          git config --global --add url."https://x-access-token:${{ steps.get-pat.outputs.github-pat }}@github.com/".insteadOf "git::https://github.com/"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Create GCS Backend Bucket (if not exists)
        run: |
          # Fix for chicken-egg problem: Create backend bucket before terraform init
          BUCKET_NAME="huyen1974-web-test-tfstate"

          if ! gcloud storage buckets describe gs://$BUCKET_NAME --project=${{ secrets.GCP_PROJECT_ID }} >/dev/null 2>&1; then
            echo "Creating backend bucket: $BUCKET_NAME"
            gcloud storage buckets create gs://$BUCKET_NAME \
              --project=${{ secrets.GCP_PROJECT_ID }} \
              --location=asia-southeast1 \
              --uniform-bucket-level-access \
              --public-access-prevention

            # Enable versioning
            gcloud storage buckets update gs://$BUCKET_NAME --versioning

            echo "✓ Backend bucket created successfully"
          else
            echo "✓ Backend bucket already exists"
          fi
        working-directory: .

      - name: Terraform Init
        env:
          GIT_CONFIG_COUNT: 1
          GIT_CONFIG_KEY_0: url.https://x-access-token:${{ steps.get-pat.outputs.github-pat }}@github.com/.insteadOf
          GIT_CONFIG_VALUE_0: https://github.com/
        run: |
          terraform init \
            -backend-config="bucket=huyen1974-web-test-tfstate" \
            -backend-config="prefix=terraform/state"

      - name: Terraform Validate
        run: terraform validate -no-color

      - name: Prepare existing infrastructure (main only)
        if: github.ref == 'refs/heads/main'
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          REGION: asia-southeast1
        run: |
          set -euo pipefail

          ensure_bucket_import() {
            local resource_name="$1"
            local bucket_name="$2"

            if terraform state show "$resource_name" >/dev/null 2>&1; then
              echo "State already contains $resource_name"
              return
            fi

            if gcloud storage buckets describe "gs://$bucket_name" --project="$PROJECT_ID" >/dev/null 2>&1; then
              echo "Importing existing bucket $bucket_name into state ($resource_name)"
              terraform import "$resource_name" "$bucket_name"
            else
              echo "Bucket $bucket_name not found, skipping import"
            fi
          }

          cleanup_secret() {
            local resource_name="$1"
            local secret_id="$2"

            if terraform state show "$resource_name" >/dev/null 2>&1; then
              echo "State already contains $resource_name"
              return
            fi

            if gcloud secrets describe "$secret_id" --project="$PROJECT_ID" >/dev/null 2>&1; then
              echo "Deleting stray secret $secret_id before apply"
              gcloud secrets delete "$secret_id" --project="$PROJECT_ID" --quiet
            fi
          }

          cleanup_cloud_run() {
            local resource_name="$1"
            local service_name="$2"

            if terraform state show "$resource_name" >/dev/null 2>&1; then
              echo "State already contains $resource_name"
              return
            fi

            if gcloud run services describe "$service_name" --project="$PROJECT_ID" --region="$REGION" >/dev/null 2>&1; then
              echo "Deleting stray Cloud Run service $service_name before apply"
              gcloud run services delete "$service_name" --project="$PROJECT_ID" --region="$REGION" --quiet
            fi
          }

          cleanup_sql_instance() {
            local resource_name="$1"
            local instance_name="$2"

            if terraform state show "$resource_name" >/dev/null 2>&1; then
              echo "State already contains $resource_name"
              return
            fi

            if gcloud sql instances describe "$instance_name" --project="$PROJECT_ID" >/dev/null 2>&1; then
              echo "Deleting stray Cloud SQL instance $instance_name before apply"
              gcloud sql instances delete "$instance_name" --project="$PROJECT_ID" --quiet
            fi
          }

          cleanup_artifact_registry() {
            local resource_name="$1"
            local repo_name="$2"

            if terraform state show "$resource_name" >/dev/null 2>&1; then
              echo "State already contains $resource_name"
              return
            fi

            if gcloud artifacts repositories describe "$repo_name" --project="$PROJECT_ID" --location="$REGION" >/dev/null 2>&1; then
              echo "Deleting stray Artifact Registry repo $repo_name before apply"
              gcloud artifacts repositories delete "$repo_name" --project="$PROJECT_ID" --location="$REGION" --quiet
            fi
          }

          ensure_bucket_import "google_storage_bucket.tfstate" "huyen1974-web-test-tfstate"
          ensure_bucket_import "google_storage_bucket.backup" "huyen1974-web-test-backup"

          cleanup_secret "google_secret_manager_secret.directus_key" "directus-key-test"
          cleanup_secret "google_secret_manager_secret.directus_secret" "directus-secret-test"
          cleanup_secret "google_secret_manager_secret.directus_admin_password" "directus-admin-password-test"
          cleanup_secret "google_secret_manager_secret.directus_mysql_password" "directus-mysql-password-test"
          cleanup_secret "google_secret_manager_secret.kestra_encryption_key" "kestra-encryption-key-test"
          cleanup_secret "google_secret_manager_secret.kestra_postgres_password" "kestra-postgres-password-test"
          cleanup_secret "google_secret_manager_secret.chatwoot_secret_key_base" "chatwoot-secret-key-base-test"
          cleanup_secret "google_secret_manager_secret.chatwoot_mysql_password" "chatwoot-mysql-password-test"

          cleanup_cloud_run "google_cloud_run_v2_service.directus" "directus-test"
          cleanup_cloud_run "google_cloud_run_v2_service.kestra" "kestra-test"
          cleanup_cloud_run "google_cloud_run_v2_service.chatwoot" "chatwoot-test"

          cleanup_sql_instance "google_sql_database_instance.mysql_directus" "mysql-directus-web-test"
          cleanup_sql_instance "google_sql_database_instance.postgres_kestra" "postgres-kestra-web-test"

          cleanup_artifact_registry "google_artifact_registry_repository.web_test" "web-test"

      - name: Terraform Plan
        id: plan
        run: |
          set +e
          plan_output=$(terraform plan -no-color -detailed-exitcode \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="env=test" \
            -out=tfplan 2>&1)
          exit_code=$?
          set -e

          echo "$plan_output"

          # Exit code 0 = no changes, 1 = error, 2 = changes detected
          if [ $exit_code -eq 1 ]; then
            echo "❌ Terraform plan failed"
            exit 1
          elif [ $exit_code -eq 2 ]; then
            echo "✓ Terraform plan succeeded with changes detected"
            exit 0
          else
            echo "✓ Terraform plan succeeded with no changes"
            exit 0
          fi

      - name: Terraform Apply (if main branch)
        if: github.ref == 'refs/heads/main'
        run: terraform apply -auto-approve tfplan

      - name: Comment PR with Plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('terraform/tfplan', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Terraform Plan

              <details>
              <summary>Show Plan Output</summary>

              \`\`\`
              ${plan.substring(0, 65000)}
              \`\`\`

              </details>`
            });
