name: Terraform Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Prevent concurrent Terraform deployments to avoid state conflicts
concurrency:
  group: terraform-deploy-lock
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write
  pull-requests: write

jobs:
  pass_gate:
    name: Pass Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run Nuxt type check
        run: npx nuxi typecheck

  guard_bootstrap_scaffold:
    name: Guard Bootstrap Scaffold
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Terraform structure
        run: |
          if [ ! -f "terraform/main.tf" ]; then
            echo "Error: terraform/main.tf not found"
            exit 1
          fi
          if [ ! -f "terraform/backend.tf" ]; then
            echo "Error: terraform/backend.tf not found"
            exit 1
          fi
          echo "Bootstrap scaffold validation passed"

  quality_gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run ESLint (if configured)
        run: |
          # Check if lint script exists in package.json
          if grep -q '"lint"' package.json; then
            echo "Lint script found, running..."
            npm run lint
          else
            echo "No lint script configured in package.json, skipping"
          fi

      - name: Check package.json validity
        run: |
          node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))"
          echo "package.json is valid JSON"

      - name: Check for common issues
        run: |
          # Check for .env files that shouldn't be committed
          if [ -f ".env" ] || [ -f ".env.local" ]; then
            echo "Warning: .env files found in repository"
          fi
          echo "Quality checks passed"

  e2e_smoke_test:
    name: E2E Smoke Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Build Nuxt application
        run: npm run build

      - name: Smoke test build output
        run: |
          if [ -d ".output" ]; then
            echo "Build output directory exists"
            if [ -d ".output/server" ]; then
              echo "Server build found"
            else
              echo "Error: Server build not found"
              exit 1
            fi
            echo "Smoke test passed"
          else
            echo "Error: Build output not found"
            exit 1
          fi

  deploy:
    name: deploy.yml
    runs-on: ubuntu-latest
    needs:
      - pass_gate
      - guard_bootstrap_scaffold
      - quality_gate
      - e2e_smoke_test
    defaults:
      run:
        working-directory: ./terraform
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          token_format: 'access_token'
          create_credentials_file: true

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Get GitHub PAT from Secret Manager
        id: get-pat
        uses: google-github-actions/get-secretmanager-secrets@v2
        with:
          secrets: |-
            github-pat:projects/${{ secrets.GCP_PROJECT_ID }}/secrets/gh_pat_sync_secrets/versions/latest

      - name: Configure Git for private modules
        run: |
          git config --global url."https://x-access-token:${{ steps.get-pat.outputs.github-pat }}@github.com/".insteadOf "https://github.com/"
          git config --global --add url."https://x-access-token:${{ steps.get-pat.outputs.github-pat }}@github.com/".insteadOf "git::https://github.com/"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Init
        env:
          GIT_CONFIG_COUNT: 1
          GIT_CONFIG_KEY_0: url.https://x-access-token:${{ steps.get-pat.outputs.github-pat }}@github.com/.insteadOf
          GIT_CONFIG_VALUE_0: https://github.com/
        run: |
          terraform init \
            -backend-config="bucket=huyen1974-web-test-tfstate" \
            -backend-config="prefix=terraform/state"

      - name: Terraform Validate
        run: terraform validate -no-color

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -no-color -detailed-exitcode \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="env=test" \
            -var="qdrant_cluster_id=${{ secrets.QDRANT_CLUSTER1_ID }}" \
            -var="qdrant_api_key=${{ secrets.QDRANT_CLUSTER1_KEY }}" \
            -out=tfplan || exit_code=$?

          # Exit code 0 = no changes, 1 = error, 2 = changes detected
          if [ "${exit_code:-0}" = "1" ]; then
            echo "Terraform plan failed"
            exit 1
          elif [ "${exit_code:-0}" = "2" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in plan"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi

      - name: Comment PR with Plan (on pull request)
        if: github.event_name == 'pull_request' && (success() || failure())
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const planStatus = '${{ steps.plan.outcome }}';
            const hasChanges = '${{ steps.plan.outputs.has_changes }}';

            const statusEmoji = planStatus === 'success' ? '✅' : '❌';

            const output = `#### Terraform Plan ${statusEmoji}

            **Status:** ${planStatus}
            **Changes Detected:** ${hasChanges === 'true' ? 'Yes' : 'No'}

            <details><summary>View Full Plan Output</summary>

            Check the workflow logs for detailed plan output.

            </details>

            *Terraform CI check completed for commit ${context.sha.substring(0, 7)}*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      # Steps below only run on push to main (actual deployment)
      # Start all SQL instances in parallel using async operations
      - name: Start All SQL Instances (Async)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: start_instances
        run: |
          echo "Starting all SQL instances asynchronously (in parallel)..."

          # Start MySQL Directus (async)
          echo "Initiating start for MySQL instance mysql-directus-web-test..."
          mysql_op=$(gcloud sql instances patch mysql-directus-web-test \
            --activation-policy=ALWAYS \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --async \
            --format="value(name)")
          echo "MySQL operation ID: $mysql_op"
          echo "mysql_operation_id=$mysql_op" >> $GITHUB_OUTPUT

          # Start PostgreSQL Kestra (async)
          echo "Initiating start for PostgreSQL instance postgres-kestra-web-test..."
          kestra_op=$(gcloud sql instances patch postgres-kestra-web-test \
            --activation-policy=ALWAYS \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --async \
            --format="value(name)")
          echo "Kestra operation ID: $kestra_op"
          echo "kestra_operation_id=$kestra_op" >> $GITHUB_OUTPUT

          # Start PostgreSQL Chatwoot (async)
          echo "Initiating start for PostgreSQL instance postgres-chatwoot-web-test..."
          chatwoot_op=$(gcloud sql instances patch postgres-chatwoot-web-test \
            --activation-policy=ALWAYS \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --async \
            --format="value(name)")
          echo "Chatwoot operation ID: $chatwoot_op"
          echo "chatwoot_operation_id=$chatwoot_op" >> $GITHUB_OUTPUT

          echo "All SQL instance start operations initiated successfully"
        working-directory: .

      # Wait for all async operations to complete (with 20 minute timeout per operation)
      - name: Wait for SQL Instances to Start
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "Waiting for all SQL instances to start (timeout: 20 minutes per instance)..."

          # Wait for MySQL operation (20 minute timeout = 1200 seconds)
          echo "Waiting for MySQL operation ${{ steps.start_instances.outputs.mysql_operation_id }}..."
          if gcloud beta sql operations wait ${{ steps.start_instances.outputs.mysql_operation_id }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --timeout=1200; then
            echo "✓ MySQL instance started successfully"
          else
            echo "✗ MySQL start operation timed out or failed"
            exit 1
          fi

          # Wait for Kestra operation (20 minute timeout = 1200 seconds)
          echo "Waiting for Kestra operation ${{ steps.start_instances.outputs.kestra_operation_id }}..."
          if gcloud beta sql operations wait ${{ steps.start_instances.outputs.kestra_operation_id }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --timeout=1200; then
            echo "✓ PostgreSQL Kestra instance started successfully"
          else
            echo "✗ Kestra start operation timed out or failed"
            exit 1
          fi

          # Wait for Chatwoot operation (20 minute timeout = 1200 seconds)
          echo "Waiting for Chatwoot operation ${{ steps.start_instances.outputs.chatwoot_operation_id }}..."
          if gcloud beta sql operations wait ${{ steps.start_instances.outputs.chatwoot_operation_id }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --timeout=1200; then
            echo "✓ PostgreSQL Chatwoot instance started successfully"
          else
            echo "✗ Chatwoot start operation timed out or failed"
            exit 1
          fi

          echo "All SQL instances started successfully"
        working-directory: .

      # Verify all instances are actually in RUNNABLE state
      - name: Verify All Instances are RUNNABLE
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "Verifying all SQL instances are RUNNABLE..."

          for instance in mysql-directus-web-test postgres-kestra-web-test postgres-chatwoot-web-test; do
            state=$(gcloud sql instances describe $instance \
              --project=${{ secrets.GCP_PROJECT_ID }} \
              --format="value(state)")

            if [ "$state" != "RUNNABLE" ]; then
              echo "✗ Error: $instance is not RUNNABLE (current state: $state)"
              exit 1
            fi
            echo "✓ $instance is RUNNABLE"
          done

          echo "All SQL instances verified as RUNNABLE"
        working-directory: .

      - name: Terraform Apply
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.plan.outputs.has_changes == 'true'
        run: |
          echo "Applying Terraform changes..."
          terraform apply -auto-approve tfplan

      - name: Stop All SQL Instances (Always run on main push)
        if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "Stopping all SQL instances to save costs..."

          echo "Stopping MySQL instance mysql-directus-web-test..."
          gcloud sql instances patch mysql-directus-web-test \
            --activation-policy=NEVER \
            --project=${{ secrets.GCP_PROJECT_ID }} || echo "Failed to stop MySQL instance"

          echo "Stopping PostgreSQL instance postgres-kestra-web-test..."
          gcloud sql instances patch postgres-kestra-web-test \
            --activation-policy=NEVER \
            --project=${{ secrets.GCP_PROJECT_ID }} || echo "Failed to stop PostgreSQL Kestra instance"

          echo "Stopping PostgreSQL instance postgres-chatwoot-web-test..."
          gcloud sql instances patch postgres-chatwoot-web-test \
            --activation-policy=NEVER \
            --project=${{ secrets.GCP_PROJECT_ID }} || echo "Failed to stop PostgreSQL Chatwoot instance"

          echo "All SQL instances stopped successfully"
        working-directory: .

