name: Self-Healing Restoration

# =============================================================================
# OPS-SELF-HEAL: Automated APPENDIX 16 Compliance Restoration
# =============================================================================
# PURPOSE: Ensure Directus maintains configuration after cold starts/restarts
# TRIGGER: After deployments, on schedule, or manually
# IDEMPOTENT: Safe to run multiple times - checks before creating
# =============================================================================

on:
  # Run after infrastructure deployments
  workflow_run:
    workflows: ["Terraform Deploy", "Terraform Infra"]
    types:
      - completed
    branches:
      - main

  # Scheduled self-healing (every 6 hours)
  schedule:
    - cron: '0 */6 * * *'

  # Manual trigger for emergency restoration
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target Directus URL (leave empty for default)'
        required: false
        type: string

permissions:
  contents: read
  id-token: write

env:
  DEFAULT_DIRECTUS_URL: "https://directus-test-pfne2mqwja-as.a.run.app"

jobs:
  self-heal:
    name: Restore APPENDIX 16 Compliance
    runs-on: ubuntu-latest
    # Only run if triggered workflow succeeded (or for schedule/manual)
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install web dependencies
        working-directory: ./web
        run: pnpm install --frozen-lockfile

      - name: Validate GCP service account key
        run: |
          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "::error::Missing GCP_SA_KEY secret"
            exit 1
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID || '812872501910' }}
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Determine Target URL
        id: target
        run: |
          if [ -n "${{ inputs.target_url }}" ]; then
            echo "url=${{ inputs.target_url }}" >> $GITHUB_OUTPUT
          else
            echo "url=${{ env.DEFAULT_DIRECTUS_URL }}" >> $GITHUB_OUTPUT
          fi

      - name: Fetch Admin Credentials
        id: creds
        run: |
          EMAIL=$(gcloud secrets versions access latest --secret="DIRECTUS_ADMIN_EMAIL_test" 2>/dev/null || echo "")
          PASSWORD=$(gcloud secrets versions access latest --secret="DIRECTUS_ADMIN_PASSWORD_test" 2>/dev/null || echo "")

          if [ -z "$EMAIL" ] || [ -z "$PASSWORD" ]; then
            echo "::error::Failed to fetch admin credentials from Secret Manager"
            exit 1
          fi

          echo "::add-mask::$PASSWORD"
          echo "email=$EMAIL" >> $GITHUB_OUTPUT
          echo "password=$PASSWORD" >> $GITHUB_OUTPUT

      - name: Wait for Directus to be Ready
        run: |
          echo "Waiting for Directus to be ready..."
          MAX_ATTEMPTS=30
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.target.outputs.url }}/server/health" || echo "000")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "Directus is ready (HTTP $HTTP_CODE)"
              break
            fi

            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: HTTP $HTTP_CODE - waiting..."
            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done

          if [ $ATTEMPT -gt $MAX_ATTEMPTS ]; then
            echo "::error::Directus did not become ready in time"
            exit 1
          fi

      # =========================================================================
      # SELF-HEALING SEQUENCE (Idempotent)
      # =========================================================================

      - name: "Step 1: Apply Schema (Idempotent)"
        env:
          DIRECTUS_URL: ${{ steps.target.outputs.url }}
          DIRECTUS_ADMIN_EMAIL: ${{ steps.creds.outputs.email }}
          DIRECTUS_ADMIN_PASSWORD: ${{ steps.creds.outputs.password }}
        run: |
          echo "=== Step 1: Schema Apply ==="
          python3 scripts/directus/schema_apply.py --execute || echo "Schema apply completed (may have skipped existing)"

      - name: "Step 2: Deploy Cache Warmer Flows"
        working-directory: ./web
        env:
          DIRECTUS_URL: ${{ steps.target.outputs.url }}
          DIRECTUS_ADMIN_EMAIL: ${{ steps.creds.outputs.email }}
          DIRECTUS_ADMIN_PASSWORD: ${{ steps.creds.outputs.password }}
        run: |
          echo "=== Step 2: Cache Warmer Flows ==="
          npx tsx scripts/e1-07_setup_cache_warmer.ts

      - name: "Step 3: Deploy Maintenance Flows"
        working-directory: ./web
        env:
          DIRECTUS_URL: ${{ steps.target.outputs.url }}
          DIRECTUS_ADMIN_EMAIL: ${{ steps.creds.outputs.email }}
          DIRECTUS_ADMIN_PASSWORD: ${{ steps.creds.outputs.password }}
        run: |
          echo "=== Step 3: Maintenance Flows ==="
          npx tsx scripts/e1-08_setup_maintenance_flows.ts

      - name: "Step 4: Seed Content & Branding"
        env:
          DIRECTUS_URL: ${{ steps.target.outputs.url }}
          DIRECTUS_ADMIN_EMAIL: ${{ steps.creds.outputs.email }}
          DIRECTUS_ADMIN_PASSWORD: ${{ steps.creds.outputs.password }}
        run: |
          echo "=== Step 4: Seed Content & Branding ==="
          python3 scripts/directus/seed_minimal.py

      - name: "Step 5: Fix Public Permissions"
        working-directory: ./web
        env:
          DIRECTUS_URL: ${{ steps.target.outputs.url }}
          DIRECTUS_ADMIN_EMAIL: ${{ steps.creds.outputs.email }}
          DIRECTUS_ADMIN_PASSWORD: ${{ steps.creds.outputs.password }}
        run: |
          echo "=== Step 5: Public Permissions ==="
          npx tsx scripts/e1-11_fix_public_permissions.ts

      - name: "Step 6: Seed Golden Asset"
        working-directory: ./web
        env:
          DIRECTUS_URL: ${{ steps.target.outputs.url }}
          DIRECTUS_ADMIN_EMAIL: ${{ steps.creds.outputs.email }}
          DIRECTUS_ADMIN_PASSWORD: ${{ steps.creds.outputs.password }}
        run: |
          echo "=== Step 6: Golden Asset ==="
          npx tsx scripts/e1-10_seed_branding_navigation.ts

      # =========================================================================
      # VERIFICATION
      # =========================================================================

      - name: Verify Restoration
        env:
          DIRECTUS_URL: ${{ steps.target.outputs.url }}
          DIRECTUS_ADMIN_EMAIL: ${{ steps.creds.outputs.email }}
          DIRECTUS_ADMIN_PASSWORD: ${{ steps.creds.outputs.password }}
        run: |
          echo "=== VERIFICATION ==="

          # Check public access
          PAGES_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$DIRECTUS_URL/items/pages?limit=1")
          echo "Public Pages: HTTP $PAGES_STATUS"

          # Check golden asset
          ASSET_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$DIRECTUS_URL/assets/b18f3792-bd31-43e5-8a7d-b25d76f41dd9")
          echo "Golden Asset: HTTP $ASSET_STATUS"

          # Check branding (via authenticated request)
          TOKEN_RESP=$(curl -s -X POST "$DIRECTUS_URL/auth/login" \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"$DIRECTUS_ADMIN_EMAIL\",\"password\":\"$DIRECTUS_ADMIN_PASSWORD\"}")

          TOKEN=$(echo "$TOKEN_RESP" | python3 -c "import sys,json; print(json.load(sys.stdin).get('data',{}).get('access_token',''))" 2>/dev/null || echo "")

          if [ -n "$TOKEN" ]; then
            SETTINGS=$(curl -s "$DIRECTUS_URL/settings" -H "Authorization: Bearer $TOKEN")
            PROJECT_NAME=$(echo "$SETTINGS" | python3 -c "import sys,json; print(json.load(sys.stdin).get('data',{}).get('project_name','UNKNOWN'))" 2>/dev/null || echo "UNKNOWN")
            echo "Project Name: '$PROJECT_NAME'"

            FLOWS_COUNT=$(curl -s "$DIRECTUS_URL/flows?filter[status][_eq]=active" -H "Authorization: Bearer $TOKEN" | \
              python3 -c "import sys,json; print(len(json.load(sys.stdin).get('data',[])))" 2>/dev/null || echo "0")
            echo "Active Flows: $FLOWS_COUNT"
          fi

          # Final verdict
          if [ "$PAGES_STATUS" = "200" ] && [ "$ASSET_STATUS" = "200" ]; then
            echo ""
            echo "=============================================="
            echo "SELF-HEALING COMPLETE - System is healthy"
            echo "=============================================="
          else
            echo ""
            echo "::warning::Some checks did not pass - manual review may be needed"
          fi
