name: Pass Gate
on:
  pull_request:
    branches: [main]
  push:

concurrency:
  group: pass-gate-${{ github.ref }}
  cancel-in-progress: true

permissions:
  id-token: write
  contents: read

jobs:
  terraform-validate:
    name: terraform validate (early)
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    env:
      TF_IN_AUTOMATION: "1"
      TF_CLI_ARGS: "-no-color"
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.8.*"

      - name: Terraform format check
        shell: bash -euo pipefail {0}
        run: terraform fmt -check -recursive terraform/

      - name: Terraform init (syntax check only)
        working-directory: terraform
        shell: bash -euo pipefail {0}
        run: terraform init -backend=false -input=false -no-color

      - name: Terraform validate
        working-directory: terraform
        shell: bash -euo pipefail {0}
        run: terraform validate -no-color

  lint-only:
    name: lint-only
    runs-on: ubuntu-22.04
    needs: terraform-validate
    timeout-minutes: 25
    env:
      TF_VERSION: "1.8.5"
      TF_IN_AUTOMATION: "1"
      TF_PLUGIN_CACHE_DIR: ${{ github.workspace }}/.tf-cache
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      # Install pip-tools
      - name: Install pip-tools
        shell: bash -euo pipefail {0}
        run: |
          python -m pip install --upgrade pip
          python -m pip install 'pip-tools==7.*'

      # Compile lockfile (CP0.1 check)
      - name: Compile lockfile and check consistency
        shell: bash -euo pipefail {0}
        run: |
          pip-compile --no-upgrade pyproject.toml
          git diff --exit-code requirements.txt

      # Install pre-commit for CP0.2 check
      - name: install pre-commit
        shell: bash -euo pipefail {0}
        run: python -m pip install pre-commit==3.*

      # Pre-commit check (CP0.2)
      - name: pre-commit check
        shell: bash -euo pipefail {0}
        run: pre-commit run --all-files --color always

      # Install test dependencies (CP0.3)
      - name: install test deps
        shell: bash -euo pipefail {0}
        run: python -m pip install -e . pytest pytest-cov httpx

      # Run unit tests (CP0.3)
      - name: unit tests
        shell: bash -euo pipefail {0}
        run: pytest

  terraform-plan:
    name: terraform plan
    runs-on: ubuntu-22.04
    needs: [terraform-validate, lint-only]
    timeout-minutes: 25
    env:
      TF_VERSION: "1.8.5"
      TF_IN_AUTOMATION: "1"
      TF_PLUGIN_CACHE_DIR: ${{ github.workspace }}/.tf-cache
      TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
      TF_VAR_qdrant_api_key: ${{ secrets.QDRANT_CLUSTER1_KEY }}
      TF_VAR_qdrant_cluster_id: ${{ secrets.QDRANT_CLUSTER1_ID }}
      TF_VAR_qdrant_region: "us-east4"
      TF_BACKEND_BUCKET: "huyen1974-agent-data-tfstate-test"
      SKIP_IMPORT: 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Prep plugin cache dir
        shell: bash -euo pipefail {0}
        run: mkdir -p "${{ env.TF_PLUGIN_CACHE_DIR }}"

      - name: Cache terraform providers
        uses: actions/cache@v4
        with:
          path: ${{ env.TF_PLUGIN_CACHE_DIR }}
          key: tf-plugins-${{ runner.os }}-${{ hashFiles('terraform/.terraform.lock.hcl') }}
          restore-keys: tf-plugins-${{ runner.os }}-

      # --- Auth with WIF-first and JSON key fallback ---
      - name: Detect auth secrets
        id: detect
        shell: bash -euo pipefail {0}
        run: |
          if [[ -n "${{ secrets.GCP_WIF_PROVIDER }}" ]]; then
            echo "HAS_WIF=true" >>"$GITHUB_OUTPUT"
          fi
          if [[ -n "${{ secrets.GCP_SA_KEY_JSON }}" ]]; then
            echo "HAS_KEY=true" >>"$GITHUB_OUTPUT"
          fi

      - name: Fail if no auth secret
        if: steps.detect.outputs.HAS_WIF != 'true' && steps.detect.outputs.HAS_KEY != 'true'
        shell: bash -euo pipefail {0}
        run: |
          echo "::error::Missing both GCP_WIF_PROVIDER and GCP_SA_KEY_JSON"
          exit 1

      - name: WIF authentication
        id: auth-wif
        if: steps.detect.outputs.HAS_WIF == 'true'
        continue-on-error: true
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Fallback authentication (JSON key)
        if: failure() && steps.detect.outputs.HAS_KEY == 'true'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_JSON }}

      - name: Verify authentication success
        shell: bash -euo pipefail {0}
        run: |
          if [[ "${{ steps.auth-wif.outcome }}" == "success" ]]; then
            echo "::notice::âœ… Authentication successful via WIF"
          else
            echo "::notice::âœ… Authentication successful via JSON key fallback"
          fi
          # Test GCP access to ensure auth worked
          gcloud auth list --filter=status:ACTIVE --format="value(account)" | head -1

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # Check backend bucket (non-fatal)
      - name: Check backend bucket (non-fatal)
        shell: bash -euo pipefail {0}
        continue-on-error: true
        run: |
          gsutil ls -b gs://${TF_BACKEND_BUCKET}

      - name: Install jq for script dependencies
        shell: bash -euo pipefail {0}
        run: |
          sudo apt-get update -q
          sudo apt-get install -qy jq

      - name: Log start
        shell: bash -euo pipefail {0}
        run: echo "::notice::â± terraform init+plan with self-healing started at $(date -u)"

      - name: Terraform Plan with Self-Healing (max 2 attempts)
        shell: bash -euo pipefail {0}
        env:
          PLAN_BACKEND: ${{ github.ref == 'refs/heads/main' && 'remote' || 'local' }}
        run: |
          SECONDS=0

          mkdir -p terraform/.tf_backend_config
          cat > terraform/.tf_backend_config/backend.conf <<EOF
          bucket = "${TF_BACKEND_BUCKET}"
          prefix = "state"
          EOF

          # Use local backend for non-main branches (safer for PRs)
          if [[ "$PLAN_BACKEND" == "local" ]]; then
            echo "::notice::Using local backend mode for branch: ${{ github.ref }}"
            export TF_BACKEND_BUCKET=""
          else
            echo "::notice::Using remote backend mode for main branch"
            export TF_BACKEND_BUCKET="${TF_BACKEND_BUCKET}"
          fi

          # Run our self-healing terraform plan script
          ./scripts/tf_plan.sh terraform

          echo "::notice::â± terraform plan with self-healing finished in ${SECONDS}s"
          if [[ $SECONDS -gt 600 ]]; then
            echo "::error::Plan slower than 10 min (${SECONDS}s)"; exit 1
          fi

  secret-scan:
    name: secret-scan
    runs-on: ubuntu-22.04
    needs: terraform-plan
    steps:
      - uses: actions/checkout@v4
      - name: Install trufflehog
        shell: bash -euo pipefail {0}
        run: |
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin
      - name: Run trufflehog
        shell: bash -euo pipefail {0}
        run: |
          trufflehog filesystem . --no-update --fail --exclude-paths .trufflehogignore

  ci-hard-gate:
    name: CI Hard Gate - SHA-bound Evidence
    runs-on: ubuntu-22.04
    needs: [terraform-validate, lint-only, terraform-plan, secret-scan, manifest-drift-check]
    if: ${{ always() }}
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        shell: bash -euo pipefail {0}
        run: |
          sudo apt-get update -q
          sudo apt-get install -qy jq

      - name: Verify & Archive Logs
        shell: bash -euo pipefail {0}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NEEDS_JSON: ${{ toJson(needs) }}
        run: |
          echo "ðŸ” CI Hard Gate: Archiving evidence for SHA ${{ github.sha }}"
          ./scripts/ci_guard.sh

  agent-e2e:
    name: agent-e2e
    runs-on: ubuntu-22.04
    needs: ci-hard-gate
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        shell: bash -euo pipefail {0}
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e . pytest pytest-cov httpx

      - name: Run agent E2E tests
        shell: bash -euo pipefail {0}
        run: |
          echo "âœ… Agent E2E tests passed (placeholder implementation)"

  manifest-drift-check:
    name: manifest-drift-check
    runs-on: ubuntu-22.04
    needs: secret-scan
    steps:
      - uses: actions/checkout@v4
      - name: Check manifest drift
        shell: bash -euo pipefail {0}
        run: python scripts/collect_manifest.py --check test_manifest_baseline.txt

  # Final gate collapsed into ci-hard-gate (unskippable)
