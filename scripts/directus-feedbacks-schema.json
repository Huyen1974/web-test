{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Directus Feedbacks Collection Schema",
  "description": "Schema for importing feedbacks collection into Directus. Supports AI feedback, threading, and context snapshots.",
  "version": "1.0.0",
  "collection": {
    "collection": "feedbacks",
    "meta": {
      "collection": "feedbacks",
      "icon": "chat_bubble",
      "note": "AI and user feedback collection with threading support",
      "display_template": "{{feedback_code}} - {{title}}",
      "archive_field": "status",
      "archive_value": "archived",
      "sort_field": "date_created",
      "accountability": "all",
      "translations": [
        {
          "language": "vi-VN",
          "translation": "Phản hồi",
          "singular": "Phản hồi",
          "plural": "Các phản hồi"
        }
      ]
    },
    "schema": {
      "name": "feedbacks"
    }
  },
  "fields": [
    {
      "field": "id",
      "type": "uuid",
      "meta": {
        "hidden": true,
        "readonly": true,
        "interface": "input",
        "special": ["uuid"]
      },
      "schema": {
        "is_primary_key": true,
        "is_nullable": false
      }
    },
    {
      "field": "feedback_code",
      "type": "string",
      "meta": {
        "interface": "input",
        "readonly": true,
        "note": "Auto-generated code: FB-YYYY-NNNNN",
        "width": "half"
      },
      "schema": {
        "max_length": 20,
        "is_unique": true
      }
    },
    {
      "field": "status",
      "type": "string",
      "meta": {
        "interface": "select-dropdown",
        "display": "labels",
        "options": {
          "choices": [
            { "text": "Open", "value": "open", "color": "var(--theme--primary)" },
            { "text": "In Review", "value": "in_review", "color": "var(--theme--warning)" },
            { "text": "Resolved", "value": "resolved", "color": "var(--theme--success)" },
            { "text": "Archived", "value": "archived", "color": "var(--theme--foreground-subdued)" }
          ]
        },
        "width": "half"
      },
      "schema": {
        "default_value": "open",
        "is_nullable": false
      }
    },
    {
      "field": "feedback_type",
      "type": "string",
      "meta": {
        "interface": "select-dropdown",
        "display": "labels",
        "options": {
          "choices": [
            { "text": "Comment", "value": "comment" },
            { "text": "Review", "value": "review" },
            { "text": "Request", "value": "request" },
            { "text": "Suggestion", "value": "suggestion" },
            { "text": "Question", "value": "question" },
            { "text": "Praise", "value": "praise" },
            { "text": "AI Analysis", "value": "ai_analysis" }
          ]
        },
        "required": true,
        "width": "half"
      },
      "schema": {
        "default_value": "comment",
        "is_nullable": false
      }
    },
    {
      "field": "priority",
      "type": "string",
      "meta": {
        "interface": "select-dropdown",
        "display": "labels",
        "options": {
          "choices": [
            { "text": "Low", "value": "low", "color": "var(--theme--foreground-subdued)" },
            { "text": "Normal", "value": "normal", "color": "var(--theme--primary)" },
            { "text": "High", "value": "high", "color": "var(--theme--warning)" },
            { "text": "Urgent", "value": "urgent", "color": "var(--theme--danger)" }
          ]
        },
        "width": "half"
      },
      "schema": {
        "default_value": "normal"
      }
    },
    {
      "field": "title",
      "type": "string",
      "meta": {
        "interface": "input",
        "required": false,
        "note": "Optional title/subject for the feedback",
        "width": "full"
      },
      "schema": {
        "max_length": 500
      }
    },
    {
      "field": "content",
      "type": "text",
      "meta": {
        "interface": "input-rich-text-md",
        "required": true,
        "note": "Feedback content (Markdown supported)",
        "width": "full"
      },
      "schema": {
        "is_nullable": false
      }
    },
    {
      "field": "context_snippet",
      "type": "text",
      "meta": {
        "interface": "input-multiline",
        "note": "Snapshot of referenced content at time of feedback (max 2000 chars). Prevents AI hallucination when source changes.",
        "width": "full"
      },
      "schema": {
        "max_length": 2000
      }
    },
    {
      "field": "linked_entity_ref",
      "type": "string",
      "meta": {
        "interface": "input",
        "note": "Reference to linked entity. Format: entity_type:entity_id (e.g., doc:abc123, agent_view:45)",
        "width": "half"
      },
      "schema": {
        "max_length": 255
      }
    },
    {
      "field": "linked_entity_url",
      "type": "string",
      "meta": {
        "interface": "input",
        "note": "URL to the linked entity for quick access",
        "width": "half"
      },
      "schema": {
        "max_length": 2048
      }
    },
    {
      "field": "parent_id",
      "type": "uuid",
      "meta": {
        "interface": "select-dropdown-m2o",
        "special": ["m2o"],
        "note": "Parent feedback for threading (reply-to). Null for root feedback.",
        "width": "half",
        "options": {
          "template": "{{feedback_code}} - {{title}}"
        }
      },
      "schema": {
        "is_nullable": true,
        "foreign_key_table": "feedbacks",
        "foreign_key_column": "id"
      }
    },
    {
      "field": "replies",
      "type": "alias",
      "meta": {
        "interface": "list-o2m",
        "special": ["o2m"],
        "note": "Child replies to this feedback",
        "options": {
          "template": "{{feedback_code}} - {{content}}"
        }
      }
    },
    {
      "field": "fingerprint_id",
      "type": "string",
      "meta": {
        "interface": "input",
        "readonly": true,
        "note": "Anonymous user fingerprint for future account linking. Used when user is not authenticated.",
        "width": "half"
      },
      "schema": {
        "max_length": 64
      }
    },
    {
      "field": "author_type",
      "type": "string",
      "meta": {
        "interface": "select-dropdown",
        "options": {
          "choices": [
            { "text": "Human", "value": "human" },
            { "text": "AI Agent", "value": "ai_agent" },
            { "text": "System", "value": "system" }
          ]
        },
        "width": "half"
      },
      "schema": {
        "default_value": "human"
      }
    },
    {
      "field": "author_name",
      "type": "string",
      "meta": {
        "interface": "input",
        "note": "Display name of author (for AI: model name like 'GPT-4', 'Claude')",
        "width": "half"
      },
      "schema": {
        "max_length": 255
      }
    },
    {
      "field": "user_created",
      "type": "uuid",
      "meta": {
        "interface": "select-dropdown-m2o",
        "special": ["user-created"],
        "readonly": true,
        "hidden": true,
        "width": "half"
      },
      "schema": {
        "foreign_key_table": "directus_users",
        "foreign_key_column": "id"
      }
    },
    {
      "field": "date_created",
      "type": "timestamp",
      "meta": {
        "interface": "datetime",
        "special": ["date-created"],
        "readonly": true,
        "width": "half"
      },
      "schema": {
        "is_nullable": false
      }
    },
    {
      "field": "user_updated",
      "type": "uuid",
      "meta": {
        "interface": "select-dropdown-m2o",
        "special": ["user-updated"],
        "readonly": true,
        "hidden": true,
        "width": "half"
      },
      "schema": {
        "foreign_key_table": "directus_users",
        "foreign_key_column": "id"
      }
    },
    {
      "field": "date_updated",
      "type": "timestamp",
      "meta": {
        "interface": "datetime",
        "special": ["date-updated"],
        "readonly": true,
        "width": "half"
      }
    }
  ],
  "relations": [
    {
      "collection": "feedbacks",
      "field": "parent_id",
      "related_collection": "feedbacks",
      "meta": {
        "one_field": "replies",
        "sort_field": null,
        "one_deselect_action": "nullify"
      },
      "schema": {
        "on_delete": "SET NULL"
      }
    },
    {
      "collection": "feedbacks",
      "field": "user_created",
      "related_collection": "directus_users",
      "schema": {
        "on_delete": "SET NULL"
      }
    },
    {
      "collection": "feedbacks",
      "field": "user_updated",
      "related_collection": "directus_users",
      "schema": {
        "on_delete": "SET NULL"
      }
    }
  ],
  "permissions": {
    "public": {
      "note": "Public role cannot access feedbacks directly",
      "actions": []
    },
    "ai_agent": {
      "note": "AI Agent role for external AI models (GPT, Gemini, Claude)",
      "actions": ["create", "read"],
      "fields": {
        "create": ["feedback_type", "priority", "title", "content", "context_snippet", "linked_entity_ref", "linked_entity_url", "parent_id", "fingerprint_id", "author_type", "author_name"],
        "read": "*"
      },
      "item_permissions": {
        "read": {
          "_and": [
            { "status": { "_neq": "archived" } }
          ]
        }
      }
    }
  },
  "flows": {
    "auto_generate_feedback_code": {
      "name": "Auto Generate Feedback Code",
      "trigger": "event",
      "trigger_config": {
        "scope": ["items.create"],
        "collections": ["feedbacks"]
      },
      "operations": [
        {
          "type": "exec",
          "name": "Generate Code",
          "options": {
            "code": "const year = new Date().getFullYear();\nconst count = await $context.database('feedbacks').count('id as count').first();\nconst seq = String((count?.count || 0) + 1).padStart(5, '0');\nreturn { feedback_code: `FB-${year}-${seq}` };"
          }
        },
        {
          "type": "item-update",
          "name": "Update Feedback Code",
          "options": {
            "collection": "feedbacks",
            "key": "{{$trigger.key}}",
            "payload": {
              "feedback_code": "{{$last.feedback_code}}"
            }
          }
        }
      ]
    }
  },
  "import_instructions": {
    "step_1": "Go to Directus Admin > Settings > Data Model",
    "step_2": "Click 'Create Collection' and name it 'feedbacks'",
    "step_3": "Add each field from the 'fields' array above",
    "step_4": "Set up the self-referential relation for parent_id/replies",
    "step_5": "Create the AI_Agent role with permissions from 'permissions.ai_agent'",
    "step_6": "Create Flow for auto-generating feedback_code (see 'flows' section)",
    "step_7": "Test by creating a feedback via API with AI_Agent token"
  }
}
